cubes:
  - name: landed_costs
    sql: >
      SELECT
        tl.transaction,
        tl.id as line_id,
        tl.item,
        CAST(tl.amount AS FLOAT64) as landed_cost_amount,
        CAST(tl.foreignamount AS FLOAT64) as foreign_landed_cost,
        CAST(tl.estgrossprofit AS FLOAT64) as estimated_gross_profit,
        CAST(tl.estgrossprofitpercent AS FLOAT64) as estimated_gp_percent,
        CAST(tl.subsidiary AS INT64) as subsidiary_id,
        tl.transaction_date as receipt_date,
        tl.transaction_type,
        tl.blandedcost
      FROM gpc.transaction_lines_denormalized_mv tl
      WHERE tl.transaction_type = 'ItemRcpt'
        AND tl.mainline = 'F'
        AND CAST(tl.amount AS FLOAT64) > 0
        AND tl.blandedcost = 'T'

    title: Landed Costs Analysis
    description: >
      Landed costs (freight, duties, customs) from Item Receipts identified by blandedcost='T' flag.
      These are additional costs added to inventory beyond the base item cost.

      Uses transaction_lines_denormalized_mv which includes foreignamount, subsidiary, and blandedcost fields
      not available in the base transaction_lines table.

      NetSuite stores landed costs using double-entry accounting with offsetting positive/negative amounts.
      This cube filters for positive amounts only (amount > 0) and blandedcost='T' to get only actual
      landed cost lines, not regular item receipt lines.

    measures:
      - name: total_landed_costs
        sql: "{CUBE}.landed_cost_amount"
        type: sum
        format: currency
        description: "Total landed costs (freight + duties) for Item Receipts (LAND001)"

      - name: total_foreign_landed_costs
        sql: "{CUBE}.foreign_landed_cost"
        type: sum
        format: currency
        description: "Landed costs in foreign currency before conversion"

      - name: avg_landed_cost_per_receipt
        sql: "{total_landed_costs} / NULLIF({receipt_count}, 0)"
        type: number
        format: currency
        description: "Average landed cost per item receipt transaction"

      - name: receipt_count
        type: count_distinct_approx
        sql: "{CUBE}.transaction"
        description: "Number of unique item receipt transactions with landed costs"

      - name: landed_cost_line_count
        type: count
        description: "Number of individual landed cost line items"

    dimensions:
      - name: transaction
        sql: "{CUBE}.transaction"
        type: number
        primary_key: true
        description: "Item Receipt transaction ID"

      - name: line_id
        sql: "{CUBE}.line_id"
        type: number
        description: "Transaction line ID"

      - name: item
        sql: "{CUBE}.item"
        type: number
        description: "Item ID (for landed cost allocation)"

      - name: transaction_type
        sql: "{CUBE}.transaction_type"
        type: string
        description: "Transaction type (should always be ItemRcpt)"

      - name: receipt_date
        sql: "CAST({CUBE}.receipt_date AS TIMESTAMP)"
        type: time
        description: "Date of item receipt"

      - name: subsidiary_id
        sql: "{CUBE}.subsidiary_id"
        type: number
        description: "Subsidiary ID where receipt was recorded"

    joins:
      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.id}"

      - name: subsidiaries
        relationship: many_to_one
        sql: "{CUBE}.subsidiary_id = {subsidiaries.id}"

    pre_aggregations:
      # Monthly landed costs by item
      # REBUILD REQUIRED: v67 fix - switched to transaction_lines_denormalized_mv for foreignamount, subsidiary, blandedcost fields
      - name: monthly_landed_costs
        measures:
          - total_landed_costs
          - total_foreign_landed_costs
          - receipt_count
          - landed_cost_line_count
        dimensions:
          - item
          - subsidiary_id
        time_dimension: receipt_date
        granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
          # Force rebuild after v66 fix (2026-01-29)
