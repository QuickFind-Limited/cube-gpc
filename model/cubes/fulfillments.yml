cubes:
  - name: fulfillments
    sql: SELECT * FROM fulfillments
    title: Fulfillments
    description: Item fulfillment records tracking shipments and deliveries

    joins:
      - name: transactions
        relationship: many_to_one
        sql: "{CUBE}.entity = {transactions.id}"

    measures:
      - name: fulfillment_count
        type: count
        description: Total number of fulfillments

      - name: unique_orders
        sql: "{CUBE}.entity"
        type: count_distinct_approx
        description: Number of unique orders fulfilled

      - name: shipped_count
        type: count
        filters:
          - sql: "{CUBE}.status = 'C'"
        description: Number of shipped fulfillments

      - name: pending_count
        type: count
        filters:
          - sql: "{CUBE}.status = 'A'"
        description: Number of pending fulfillments

      - name: fulfillments_per_order
        sql: "1.0 * {fulfillment_count} / NULLIF({unique_orders}, 0)"
        type: number
        description: Average fulfillments per order (FD003)

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: entity
        sql: "{CUBE}.entity"
        type: number
        description: Related entity/order ID

      - name: tranid
        sql: "{CUBE}.tranid"
        type: string
        title: Fulfillment Number
        description: Fulfillment transaction ID (e.g., IF279014)

      - name: trandate
        sql: "CAST({CUBE}.trandate AS TIMESTAMP)"
        type: time
        description: Fulfillment date

      - name: month
        sql: "DATE_TRUNC('month', CAST({CUBE}.trandate AS TIMESTAMP))"
        type: time
        description: Fulfillment month

      - name: status
        sql: "{CUBE}.status"
        type: string
        description: "Fulfillment status: A (Pending), B (Picked), C (Shipped)"

      - name: status_name
        sql: >
          CASE
            WHEN {CUBE}.status = 'A' THEN 'Pending'
            WHEN {CUBE}.status = 'B' THEN 'Picked'
            WHEN {CUBE}.status = 'C' THEN 'Shipped'
            ELSE 'Unknown'
          END
        type: string
        description: Human-readable fulfillment status

      - name: shipcarrier
        sql: "{CUBE}.shipcarrier"
        type: string
        description: Shipping carrier name

      - name: shipmethod
        sql: "{CUBE}.shipmethod"
        type: number
        description: Shipping method ID

    segments:
      - name: shipped
        sql: "{CUBE}.status = 'C'"

      - name: pending
        sql: "{CUBE}.status = 'A'"

      - name: picked
        sql: "{CUBE}.status = 'B'"

    pre_aggregations:
      # Fulfillment status analysis
      - name: fulfillment_analysis
        measures:
          - fulfillment_count
          - unique_orders
          - shipped_count
          - pending_count
          - fulfillments_per_order
        dimensions:
          - status
          - status_name
          - shipcarrier
        time_dimension: trandate
        granularity: month
        refresh_key:
          every: 24 hour
