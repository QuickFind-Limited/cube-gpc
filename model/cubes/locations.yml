cubes:
  - name: locations
    sql: SELECT * FROM gpc_data_2026_01_26.locations
    title: Locations
    description: Warehouse and store locations with centralized channel type logic. Grain: one row per location.

    measures:
      - name: location_count
        type: count
        description: Total number of locations

    dimensions:
      - name: location_id
        sql: "{CUBE}.location_id"
        type: number
        primary_key: true
        description: Unique identifier for the location

      - name: location_name
        sql: "{CUBE}.location_name"
        type: string
        description: Location name

      - name: location_fullname
        sql: "{CUBE}.location_fullname"
        type: string
        description: Full hierarchical location name

      - name: location_external_id
        sql: "{CUBE}.location_external_id"
        type: string
        description: External system identifier for the location

      - name: location_type_id
        sql: "{CUBE}.location_type_id"
        type: number
        description: Location type identifier (FK to location type lookup)

      # CRITICAL: Centralized channel type logic - Rule 4
      - name: channel_type
        sql: >
          CASE
            WHEN {CUBE}.location_name IS NULL THEN 'D2C'
            WHEN {CUBE}.location_name LIKE 'Bleckmann%' AND {CUBE}.location_name NOT LIKE '%Quarantine%' AND {CUBE}.location_name NOT LIKE '%Miscellaneous%' THEN 'D2C'
            WHEN {CUBE}.location_name IN ('Meteor Space', '2Flow') THEN 'D2C'
            WHEN {CUBE}.location_name IN (
              'Dundrum Town Centre', 'Mahon Point', 'Crescent Centre', 'Liffey Valley',
              'Kildare Village', 'Blanchardstown Centre', 'Galway', 'Swords Pavillon', 'Jervis Centre',
              'Westfield London', 'Manchester', 'Belfast', 'Liverpool'
            ) THEN 'RETAIL'
            WHEN {CUBE}.location_name LIKE 'Wholesale%' THEN 'B2B_WHOLESALE'
            WHEN {CUBE}.location_name LIKE 'Lifestyle Sports%' AND {CUBE}.location_name NOT LIKE '%Quarantine%' THEN 'B2B_WHOLESALE'
            WHEN {CUBE}.location_name IN ('Otrium', 'The Very Group', 'Digme', 'Academy Crests') THEN 'PARTNER'
            WHEN {CUBE}.location_name LIKE 'Events%' THEN 'EVENTS'
            ELSE 'OTHER'
          END
        type: string
        description: "Channel type: D2C, RETAIL, B2B_WHOLESALE, PARTNER, EVENTS, OTHER"

      - name: location_type
        sql: >
          CASE
            WHEN {CUBE}.location_name IN (
              'Dundrum Town Centre', 'Mahon Point', 'Crescent Centre', 'Liffey Valley',
              'Kildare Village', 'Blanchardstown Centre', 'Galway', 'Swords Pavillon', 'Jervis Centre',
              'Westfield London', 'Manchester', 'Belfast', 'Liverpool'
            ) THEN 'RETAIL'
            WHEN {CUBE}.location_name LIKE 'Bleckmann%' AND {CUBE}.location_name NOT LIKE '%Quarantine%' AND {CUBE}.location_name NOT LIKE '%Miscellaneous%' THEN 'FULFILLMENT'
            WHEN {CUBE}.location_name IN ('Meteor Space', '2Flow') THEN 'FULFILLMENT'
            WHEN {CUBE}.location_name LIKE 'Wholesale%' THEN 'WHOLESALE'
            WHEN {CUBE}.location_name LIKE 'Lifestyle Sports B2B%' THEN 'B2B_PARTNER'
            WHEN {CUBE}.location_name IN ('The Very Group', '2Flow') THEN 'B2B_PARTNER'
            WHEN {CUBE}.location_name IN ('Otrium', 'Digme', 'Academy Crests', 'PCH-UK') THEN 'MARKETPLACE'
            WHEN {CUBE}.location_name LIKE '%Quarantine%' OR {CUBE}.location_name LIKE '%Miscellaneous%' OR {CUBE}.location_name = 'Kildare B Stock' THEN 'RETURNS_QC'
            WHEN {CUBE}.location_name LIKE 'Events%' THEN 'EVENTS'
            WHEN {CUBE}.location_name LIKE 'Headquarters%' THEN 'HQ_ADMIN'
            WHEN {CUBE}.location_name LIKE 'PCH China%' THEN 'SOURCING'
            ELSE 'OTHER'
          END
        type: string
        description: "Location type: RETAIL, FULFILLMENT, WHOLESALE, B2B_PARTNER, MARKETPLACE, RETURNS_QC, EVENTS, HQ_ADMIN, SOURCING, OTHER"

      - name: region
        sql: >
          CASE
            WHEN {CUBE}.subsidiary_id = 2
              AND {CUBE}.location_name NOT LIKE 'Bleckmann%'
              AND {CUBE}.location_name NOT LIKE 'PCH China%'
            THEN 'IRELAND'
            WHEN {CUBE}.subsidiary_id = 6
              AND {CUBE}.location_name NOT LIKE 'Bleckmann Australia%'
              AND {CUBE}.location_name NOT LIKE 'Bleckmann Aussie%'
              AND {CUBE}.location_name NOT LIKE 'Bleckmann USA%'
            THEN 'UK'
            WHEN {CUBE}.location_name LIKE 'Bleckmann BE%' THEN 'EU'
            WHEN {CUBE}.location_name = 'Bleckmann UK' THEN 'UK'
            WHEN {CUBE}.location_name LIKE 'Bleckmann UK%' THEN 'UK'
            WHEN {CUBE}.location_name = 'Bleckmann Swindon' THEN 'UK'
            ELSE 'GLOBAL'
          END
        type: string
        description: "Location region: IRELAND (sub 2), UK (sub 6), EU (Bleckmann BE), GLOBAL (overseas warehouses)"

      - name: is_sellable_location
        sql: "{CUBE}.is_sellable_location"
        type: boolean
        description: Indicates if this location can fulfill orders

      - name: subsidiary_id
        sql: "{CUBE}.subsidiary_id"
        type: number
        description: Subsidiary identifier (FK to subsidiaries)

      - name: is_inactive
        sql: "{CUBE}.is_inactive"
        type: boolean
        description: Indicates if the location is inactive

      - name: make_inventory_available
        sql: "{CUBE}.make_inventory_available"
        type: boolean
        description: Indicates if inventory at this location is available for sale

      - name: include_in_control_tower
        sql: "{CUBE}.include_in_control_tower"
        type: boolean
        description: Indicates if location is included in control tower visibility

      - name: geolocation_method
        sql: "{CUBE}.geolocation_method"
        type: string
        description: Method used for geolocation (e.g., POSTALCODE, LATLONG)

      - name: latitude
        sql: "CAST({CUBE}.latitude AS FLOAT64)"
        type: number
        description: Geographic latitude coordinate

      - name: longitude
        sql: "CAST({CUBE}.longitude AS FLOAT64)"
        type: number
        description: Geographic longitude coordinate

      - name: last_modified_date
        sql: "TIMESTAMP({CUBE}.last_modified_date)"
        type: time
        description: Last modification timestamp

      - name: main_address_id
        sql: "{CUBE}.main_address_id"
        type: number
        description: Main address identifier (FK to addresses)

    segments:
      - name: active_locations
        sql: "{CUBE}.is_inactive = false"
        description: "Active locations only"

      - name: sellable_locations
        sql: "{CUBE}.is_sellable_location = true AND {CUBE}.is_inactive = false"
        description: "Locations that can fulfill customer orders"

      - name: retail_stores
        sql: >
          {CUBE}.location_name IN (
            'Dundrum Town Centre', 'Mahon Point', 'Crescent Centre', 'Liffey Valley',
            'Kildare Village', 'Blanchardstown Centre', 'Galway', 'Swords Pavillon', 'Jervis Centre',
            'Westfield London', 'Manchester', 'Belfast', 'Liverpool'
          )
        description: "Physical retail store locations"

      - name: fulfillment_centers
        sql: >
          ({CUBE}.location_name LIKE 'Bleckmann%' AND {CUBE}.location_name NOT LIKE '%Quarantine%' AND {CUBE}.location_name NOT LIKE '%Miscellaneous%')
          OR {CUBE}.location_name IN ('Meteor Space', '2Flow')
        description: "Warehouse fulfillment centers for D2C and wholesale"

    joins:
      - name: subsidiaries
        relationship: many_to_one
        sql: "{CUBE}.subsidiary_id = {subsidiaries.subsidiary_id}"

    pre_aggregations:
      - name: location_analysis
        measures:
          - location_count
        dimensions:
          - channel_type
          - location_type
          - region
        refresh_key:
          every: 1 day
