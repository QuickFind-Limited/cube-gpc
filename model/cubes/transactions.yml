cubes:
  - name: transactions
    sql: SELECT * FROM gpc_data_2026_01_26.transactions
    title: Transactions
    description: >
      Transaction headers across all transaction types (orders, invoices, cash sales, returns, payments, etc.).
      Grain: one row per transaction header.
      Entity contamination: Contains entity_type and transaction_in_scope fields for filtering system entities (webstore/POS payment processors).
      Note: Schema updated to new BigQuery dataset - custom fields from old schema (custbody_customer_email, billing_country, etc.) may not be present in base table.

    joins:
      - name: currencies
        relationship: many_to_one
        sql: "{CUBE}.currency = {currencies.currency_id}"

      - name: subsidiaries
        relationship: many_to_one
        sql: "{CUBE}.subsidiary = {subsidiaries.subsidiary_id}"

    measures:
      - name: transactions_count
        type: count
        description: Total number of transactions

      - name: order_count
        type: count
        description: Total number of transactions (alias for backwards compatibility)

      - name: fulfilled_orders
        type: count
        filters:
          - sql: "{CUBE}.type IN ('CustInvc', 'CashSale') AND {CUBE}.status = 'B'"
        description: "Number of fulfilled/billed orders (OM002). Counts billed invoices (CustInvc) and cash sales (CashSale) with status 'B'. Excludes sales orders with status 'G' which are pending billing (not yet fulfilled). For detailed shipment-level fulfillment tracking use the fulfillments cube. FIX (v65): Changed from status IN ('B', 'G') to explicitly filter CustInvc/CashSale with status='B' only, removing 12,303 incorrectly included pending sales orders (status 'G' = approved but not fulfilled)."

      - name: cancelled_orders
        type: count
        filters:
          - sql: "{CUBE}.status = 'C'"
        description: Number of cancelled orders (NOTE - primarily Shopify placeholders pre-March 2025, see documentation)

      - name: customer_credits
        type: count
        filters:
          - sql: "{CUBE}.type = 'CustCred'"
        description: Number of customer credit transactions (returns, refunds, adjustments)

      - name: revenue_transaction_count
        type: count
        filters:
          - sql: "{CUBE}.type IN ('CustInvc', 'CashSale')"
        description: Number of revenue transactions (CustInvc + CashSale) - component measure for RET005 calculation

      # Time-aligned component measures (Feb 2025+) for accurate RET005 calculations
      # Note: return_authorizations measures removed - RtnAuth transaction type not used in D2C workflow
      - name: customer_credits_aligned
        type: count
        filters:
          - sql: "{CUBE}.type = 'CustCred' AND TIMESTAMP({CUBE}.trandate) >= '2025-02-01'"
        description: Customer credits from Feb 2025 onwards (time-aligned for RET005 calculation)

      - name: revenue_transaction_count_aligned
        type: count
        filters:
          - sql: "{CUBE}.type IN ('CustInvc', 'CashSale') AND TIMESTAMP({CUBE}.trandate) >= '2025-02-01'"
        description: Revenue transactions from Feb 2025 onwards (time-aligned denominator for RET004/RET005)

      - name: total_amount
        sql: "CAST({CUBE}.total AS FLOAT64)"
        type: sum
        format: currency
        description: Sum of transaction totals in base currency

      - name: total_foreigntotal
        sql: "CAST({CUBE}.foreigntotal AS FLOAT64)"
        type: sum
        format: currency
        description: Sum of foreign totals

      - name: total_foreign_amount
        sql: "CAST({CUBE}.foreigntotal AS FLOAT64)"
        type: sum
        format: currency
        description: Sum of foreign totals for average calculation (component measure for rollup-only mode)

      - name: average_transaction_total
        sql: "{total_foreign_amount} / NULLIF({order_count}, 0)"
        type: number
        format: currency
        description: Average transaction total (calculated from components, NOT for use in pre-aggregations)

      - name: total_exchangerate
        sql: "CAST({CUBE}.exchangerate AS FLOAT64)"
        type: sum
        description: Sum of exchange rates (for averaging calculations)

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true
        description: Unique transaction identifier

      - name: tranid
        sql: "{CUBE}.tranid"
        type: string
        description: Transaction number/reference (human-readable)

      - name: type
        sql: "{CUBE}.type"
        type: string
        description: "Transaction type: SalesOrd, CustInvc, CashSale, CustCred, CustPymt, VendBill, VendPymt, etc."

      - name: trandate
        sql: "TIMESTAMP({CUBE}.trandate)"
        type: time
        description: Transaction date

      - name: entity
        sql: "{CUBE}.entity"
        type: number
        description: Entity ID (customer or vendor)

      - name: subsidiary
        sql: "{CUBE}.subsidiary"
        type: number
        description: Subsidiary ID (2=Ireland/EUR, 6=UK/GBP)

      - name: currency
        sql: "{CUBE}.currency"
        type: number
        description: Currency ID

      - name: postingperiod
        sql: "{CUBE}.postingperiod"
        type: number
        description: Accounting period ID for posting

      - name: total
        sql: "CAST({CUBE}.total AS FLOAT64)"
        type: number
        description: Transaction total in base currency

      - name: foreigntotal
        sql: "CAST({CUBE}.foreigntotal AS FLOAT64)"
        type: number
        description: Transaction total in foreign currency

      - name: foreign_total
        sql: "CAST({CUBE}.foreigntotal AS FLOAT64)"
        type: number
        description: Transaction total in foreign currency (alias for backwards compatibility)

      - name: exchangerate
        sql: "CAST({CUBE}.exchangerate AS FLOAT64)"
        type: number
        description: Exchange rate applied to transaction

      - name: status
        sql: "{CUBE}.status"
        type: string
        description: "Transaction status code: A (Pending Approval), B (Pending Fulfillment), C (Cancelled), G (Billed), Y (Pending)"

      - name: status_name
        sql: >
          CASE
            WHEN {CUBE}.status = 'A' THEN 'Pending Approval'
            WHEN {CUBE}.status = 'B' THEN 'Pending Fulfillment'
            WHEN {CUBE}.status = 'C' THEN 'Cancelled'
            WHEN {CUBE}.status = 'D' THEN 'Partially Fulfilled'
            WHEN {CUBE}.status = 'E' THEN 'Pending Billing'
            WHEN {CUBE}.status = 'F' THEN 'Pending Billing'
            WHEN {CUBE}.status = 'G' THEN 'Billed'
            WHEN {CUBE}.status = 'H' THEN 'Closed'
            WHEN {CUBE}.status = 'Y' THEN 'Pending'
            ELSE {CUBE}.status
          END
        type: string
        description: Human-readable transaction status

      - name: voided
        sql: "{CUBE}.voided"
        type: boolean
        description: Whether the transaction has been voided

      - name: posting
        sql: "{CUBE}.posting"
        type: boolean
        description: Whether the transaction posts to GL

      - name: entity_type
        sql: "{CUBE}.entity_type"
        type: string
        description: "Entity classification: 'customer', 'webstore', 'pos' - used to filter system entities"

      - name: transaction_in_scope
        sql: "{CUBE}.transaction_in_scope"
        type: boolean
        description: Whether transaction is in scope for customer analytics (excludes system entities)

      - name: paymentmethod
        sql: "{CUBE}.paymentmethod"
        type: number
        description: Payment method ID

      - name: createdfrom
        sql: "{CUBE}.createdfrom"
        type: number
        description: Source transaction ID (for transactions created from other transactions)

      - name: shipdate
        sql: "TIMESTAMP({CUBE}.shipdate)"
        type: time
        description: Ship date (when order was shipped) - used for FUL-001 fulfillment speed metrics

      - name: closedate
        sql: "TIMESTAMP({CUBE}.closedate)"
        type: time
        description: Date when transaction was closed/completed

      - name: duedate
        sql: "TIMESTAMP({CUBE}.duedate)"
        type: time
        description: Due date (for invoices and bills)

      - name: month
        sql: "TIMESTAMP_TRUNC(TIMESTAMP({CUBE}.trandate), MONTH)"
        type: time
        description: Transaction month

      - name: quarter
        sql: "TIMESTAMP_TRUNC(TIMESTAMP({CUBE}.trandate), QUARTER)"
        type: time
        description: Transaction quarter

      - name: year
        sql: "TIMESTAMP_TRUNC(TIMESTAMP({CUBE}.trandate), YEAR)"
        type: time
        description: Transaction year

      - name: week
        sql: "TIMESTAMP_TRUNC(TIMESTAMP({CUBE}.trandate), WEEK)"
        type: time
        description: Transaction week

    segments:
      - name: in_scope_only
        sql: "{CUBE}.transaction_in_scope = true"
        description: "Excludes system entities (webstore/POS payment processors) for accurate customer analytics"

      - name: customer_transactions
        sql: "{CUBE}.entity_type = 'customer'"
        description: "Only transactions from real customers (excludes webstore/POS entities)"

      - name: revenue_transactions
        sql: "{CUBE}.type IN ('CustInvc', 'CashSale')"
        description: "Revenue-generating transactions (invoices and cash sales)"

      - name: sales_orders
        sql: "{CUBE}.type = 'SalesOrd'"
        description: "Sales orders only"

      - name: fulfilled_status
        sql: "{CUBE}.status = 'G'"
        description: "Billed/fulfilled transactions"

      - name: posted_only
        sql: "{CUBE}.posting = true AND {CUBE}.voided = false"
        description: "Posted, non-voided transactions for financial reporting"

    pre_aggregations:
      # Main rollup for transaction analysis
      - name: transactions_daily
        measures:
          - transactions_count
          - order_count
          - fulfilled_orders
          - cancelled_orders
          - customer_credits
          - revenue_transaction_count
          - customer_credits_aligned
          - revenue_transaction_count_aligned
          - total_amount
          - total_foreigntotal
          - total_foreign_amount
        dimensions:
          - type
          - status
          - status_name
          - entity_type
          - transaction_in_scope
          - subsidiary
          - currency
        time_dimension: trandate
        granularity: day
        refresh_key:
          every: 1 day
