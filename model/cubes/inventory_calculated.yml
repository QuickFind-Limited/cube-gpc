cubes:
  - name: inventory_calculated
    sql: SELECT * FROM gpc_data_2026_01_26.inventory_calculated
    title: Inventory Calculated
    description: >
      Calculated inventory levels by item and location.
      Grain: one row per item-location combination.

    joins:
      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.item_id}"

      - name: locations
        relationship: many_to_one
        sql: "{CUBE}.location = {locations.location_id}"

    measures:
      - name: inventory_count
        type: count
        description: Total number of item-location inventory records

      - name: total_qty_available
        sql: "CAST({CUBE}.qty_available AS FLOAT64)"
        type: sum
        description: Total quantity available across all items and locations

      - name: total_qty_on_hand
        sql: "CAST({CUBE}.qty_on_hand AS FLOAT64)"
        type: sum
        description: Total quantity on hand across all items and locations

      - name: total_reorder_point
        sql: "CAST({CUBE}.reorder_point AS FLOAT64)"
        type: sum
        description: Total reorder point quantities across all items and locations

      - name: avg_qty_available
        sql: "CAST({CUBE}.qty_available AS FLOAT64)"
        type: avg
        description: Average quantity available per item-location

      - name: avg_qty_on_hand
        sql: "CAST({CUBE}.qty_on_hand AS FLOAT64)"
        type: avg
        description: Average quantity on hand per item-location

      - name: avg_reorder_point
        sql: "CAST({CUBE}.reorder_point AS FLOAT64)"
        type: avg
        description: Average reorder point per item-location

      - name: items_at_reorder_point
        type: count
        filters:
          - sql: "{CUBE}.qty_available <= {CUBE}.reorder_point"
        description: Count of item-location combinations at or below reorder point

      - name: items_out_of_stock
        type: count
        filters:
          - sql: "{CUBE}.qty_available <= 0"
        description: Count of item-location combinations out of stock

    dimensions:
      - name: item
        sql: "{CUBE}.item"
        type: number
        description: Item ID (foreign key to items table)

      - name: location
        sql: "{CUBE}.location"
        type: number
        description: Location ID (foreign key to locations table)

      - name: qty_available
        sql: "CAST({CUBE}.qty_available AS FLOAT64)"
        type: number
        description: Quantity available for sale or use

      - name: qty_on_hand
        sql: "CAST({CUBE}.qty_on_hand AS FLOAT64)"
        type: number
        description: Physical quantity on hand at the location

      - name: reorder_point
        sql: "CAST({CUBE}.reorder_point AS FLOAT64)"
        type: number
        description: Quantity threshold that triggers reorder

    segments:
      - name: needs_reorder
        sql: "{CUBE}.qty_available <= {CUBE}.reorder_point"
        description: "Item-locations at or below reorder point"

      - name: out_of_stock
        sql: "{CUBE}.qty_available <= 0"
        description: "Item-locations with zero or negative available quantity"

      - name: in_stock
        sql: "{CUBE}.qty_available > 0"
        description: "Item-locations with positive available quantity"

      - name: healthy_stock
        sql: "{CUBE}.qty_available > {CUBE}.reorder_point"
        description: "Item-locations with stock above reorder point"

    pre_aggregations:
      - name: inventory_snapshot
        measures:
          - inventory_count
          - total_qty_available
          - total_qty_on_hand
          - total_reorder_point
        dimensions:
          - item
          - location
        refresh_key:
          every: 1 hour
