cubes:
  - name: b2b_customers
    sql: SELECT * FROM b2b_customers
    title: B2B Customers
    description: B2B wholesale customer master data with company info, tiers, and payment terms

    measures:
      - name: customer_count
        type: count
        description: Total number of B2B customers

      - name: active_customer_count
        type: count
        filters:
          - sql: "{CUBE}.isInactive = 'False'"
        description: Number of active B2B customers

      - name: total_balance
        sql: "CAST({CUBE}.balance AS DOUBLE)"
        type: sum
        format: currency
        description: Total outstanding balance

      - name: total_overdue
        sql: "CAST({CUBE}.overdueBalance AS DOUBLE)"
        type: sum
        format: currency
        description: Total overdue balance

      - name: average_balance
        sql: "{CUBE}.balance"
        type: avg
        format: currency
        description: Average customer balance

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: entityId
        sql: "{CUBE}.entityId"
        type: string
        title: Customer Number
        description: Customer entity ID

      - name: companyName
        sql: "{CUBE}.companyName"
        type: string
        title: Company Name
        description: B2B company name

      - name: firstName
        sql: "{CUBE}.firstName"
        type: string
        description: Contact first name

      - name: lastName
        sql: "{CUBE}.lastName"
        type: string
        description: Contact last name

      - name: email
        sql: "{CUBE}.email"
        type: string
        description: Customer email

      - name: phone
        sql: "{CUBE}.phone"
        type: string
        description: Customer phone

      - name: balance
        sql: "{CUBE}.balance"
        type: number
        description: Current balance

      - name: overdueBalance
        sql: "{CUBE}.overdueBalance"
        type: number
        description: Overdue balance amount

      - name: daysOverdue
        sql: "{CUBE}.daysOverdue"
        type: number
        description: Days overdue

      - name: dateCreated
        sql: "CAST({CUBE}.dateCreated AS TIMESTAMP)"
        type: time
        description: Customer creation date

      - name: lastModifiedDate
        sql: "CAST({CUBE}.lastModifiedDate AS TIMESTAMP)"
        type: time
        description: Last modification date

      - name: isInactive
        sql: "{CUBE}.isInactive"
        type: string
        description: Whether customer is inactive

      - name: isPerson
        sql: "{CUBE}.isPerson"
        type: string
        description: Whether customer is individual (vs company)

      - name: customer_tier
        sql: "{CUBE}.custentitycustomertier"
        type: string
        description: Customer tier (Wholesale T1, T2, T3, Corporate)

      - name: wholesale_market_segment
        sql: "{CUBE}.custentitywholesalemarketsegment"
        type: string
        description: Wholesale market segment (Retail Lifestyle, Retail Sports, Corporate)

      - name: buying_group
        sql: "{CUBE}.custentitybuyinggrou"
        type: string
        description: Buying group (AIS, STAG, Faire)

      - name: pricing_tier
        sql: "{CUBE}.custentitypricingtier"
        type: number
        description: Pricing tier percentage

      - name: defaultAddress
        sql: "{CUBE}.defaultAddress"
        type: string
        description: Default shipping address

      - name: terms
        sql: "{CUBE}.terms"
        type: string
        description: Payment terms (Net 30, Net 60)

      - name: subsidiary
        sql: "{CUBE}.subsidiary"
        type: string
        description: Subsidiary (GPC Ireland, GPC UK)

      - name: currency
        sql: "{CUBE}.currency"
        type: string
        description: Customer currency

      - name: taxRegNo
        sql: "{CUBE}.custentity_tax_reg_no"
        type: string
        description: Tax registration number

      - name: url
        sql: "{CUBE}.url"
        type: string
        description: Customer website URL

      - name: comments
        sql: "{CUBE}.comments"
        type: string
        description: Customer notes/comments

      - name: giveAccess
        sql: "{CUBE}.giveAccess"
        type: string
        description: Whether customer has portal access

      - name: sendEmail
        sql: "{CUBE}.sendEmail"
        type: string
        description: Whether to send email notifications

      - name: unbilledOrders
        sql: "{CUBE}.unbilledOrders"
        type: number
        description: Unbilled orders amount

      - name: depositBalance
        sql: "{CUBE}.depositBalance"
        type: number
        description: Deposit balance

      # Aging buckets
      - name: aging1
        sql: "{CUBE}.aging1"
        type: number
        description: Aging bucket 1 (0-30 days)

      - name: aging2
        sql: "{CUBE}.aging2"
        type: number
        description: Aging bucket 2 (31-60 days)

      - name: aging3
        sql: "{CUBE}.aging3"
        type: number
        description: Aging bucket 3 (61-90 days)

      - name: aging4
        sql: "{CUBE}.aging4"
        type: number
        description: Aging bucket 4 (90+ days)

    segments:
      - name: active_customers
        sql: "{CUBE}.isInactive = 'False'"

      - name: with_balance
        sql: "{CUBE}.balance != 0"

      - name: overdue
        sql: "{CUBE}.overdueBalance < 0"

      - name: tier1
        sql: "{CUBE}.custentitycustomertier LIKE '%T1%'"

      - name: tier2
        sql: "{CUBE}.custentitycustomertier LIKE '%T2%'"

    pre_aggregations:
      - name: b2b_customer_analysis
        measures:
          - customer_count
          - active_customer_count
          - total_balance
          - total_overdue
          - average_balance
        dimensions:
          - customer_tier
          - wholesale_market_segment
          - buying_group
          - subsidiary
          - currency
        refresh_key:
          every: 1 week
