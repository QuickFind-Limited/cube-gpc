cubes:
  - name: transaction_accounting_lines_cogs
    sql_table: gpc.transaction_accounting_lines_cogs
    title: COGS Accounting Lines
    description: GL-based COGS from TransactionAccountingLine (accurate source of truth for cost of goods sold) - using external parquet table

    # Joins to transaction_lines for additional dimensions if needed
    joins:
      - name: transaction_lines
        relationship: many_to_one
        sql: "{CUBE}.transaction = {transaction_lines}.transaction"

    dimensions:
      - name: id
        sql: "CONCAT(CAST({CUBE}.transaction AS STRING), '-', CAST({CUBE}.transactionline AS STRING))"
        type: string
        primary_key: true
        description: Composite primary key (transaction-transactionline)

      - name: transaction_id
        sql: "{CUBE}.transaction"
        type: number
        description: Transaction ID (for JOIN to transaction_lines)

      - name: transactionline_id
        sql: "{CUBE}.transactionline"
        type: number
        description: Transaction line ID

      - name: transaction_date
        sql: "CAST({CUBE}.trandate AS TIMESTAMP)"
        type: time
        description: Transaction date

      - name: account_id
        sql: "{CUBE}.account"
        type: number
        description: COGS account ID

      - name: account_name
        sql: account_name
        type: string
        description: COGS account name

      - name: acctnumber
        sql: acctnumber
        type: number
        description: COGS account number

      - name: accttype
        sql: accttype
        type: string
        description: Account type (should be COGS)

      - name: cogs_category
        type: string
        case:
          when:
            - sql: "{CUBE}.account_name LIKE 'Cost of Goods Sold%'"
              label: "Product Cost"
            - sql: "{CUBE}.account_name LIKE 'Freight & Duty%'"
              label: "Freight & Duty"
            - sql: "{CUBE}.account_name LIKE 'Card & Platfrom%' OR {CUBE}.account_name LIKE 'Card & Platform%'"
              label: "Platform Fees"
            - sql: "{CUBE}.account_name LIKE 'Storage & Delivery%'"
              label: "Storage & Delivery"
            - sql: "{CUBE}.account_name LIKE 'Other Cost of Sales%'"
              label: "Other Cost of Sales"
          else:
            label: "Uncategorised"
        description: "COGS001: High-level cost category grouping. Product Cost (purchases/freight/duties), Platform Fees (Shopify/PayPal/CC), Storage & Delivery (warehousing/transport/returns), Other (packaging/samples)."

    measures:
      - name: gl_cogs
        sql: debit
        type: sum
        format: currency
        description: "GL-based COGS (sum of all COGS account debit postings) - ACCURATE source of truth, replaces corrupt total_cost field"

      - name: gl_cogs_debit
        sql: debit
        type: sum
        format: currency
        description: Total COGS debit amounts

      - name: gl_cogs_credit
        sql: credit
        type: sum
        format: currency
        description: Total COGS credit amounts

      - name: cogs_entry_count
        type: count
        description: Number of COGS GL entries

      - name: platform_fees
        sql: debit
        type: sum
        format: currency
        filters:
          - sql: "{CUBE}.account_name LIKE 'Card & Platfrom%' OR {CUBE}.account_name LIKE 'Card & Platform%'"
        description: "COGS002: Total platform/payment processing fees (Shopify, PayPal, CC, Gift Card Commission, Cash Collection, Flexible Payment). Note: source data has typo 'Platfrom' in account_name."

      - name: logistics_costs
        sql: debit
        type: sum
        format: currency
        filters:
          - sql: "{CUBE}.account_name LIKE 'Storage & Delivery%' OR {CUBE}.account_name LIKE 'Freight & Duty%'"
        description: "COGS003: Total logistics costs (Storage & Warehousing, Transport & Distribution, Returns handling, Freight & Customs, Import Duties)."

      - name: product_cost
        sql: debit
        type: sum
        format: currency
        filters:
          - sql: "{CUBE}.account_name LIKE 'Cost of Goods Sold%'"
        description: "Direct product purchase cost (COGS - Purchases, Freight, Duties & Taxes sub-accounts under Cost of Goods Sold parent)."

    pre_aggregations:
      - name: cogs_by_account
        measures:
          - gl_cogs
          - gl_cogs_debit
          - gl_cogs_credit
          - cogs_entry_count
          - platform_fees
          - logistics_costs
          - product_cost
        dimensions:
          - account_name
          - acctnumber
          - cogs_category
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day

      # Monthly rollup for faster queries
      - name: cogs_monthly_totals
        measures:
          - gl_cogs
          - cogs_entry_count
          - platform_fees
          - logistics_costs
          - product_cost
        dimensions:
          - cogs_category
        time_dimension: transaction_date
        granularity: month
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
