cubes:
  - name: transaction_accounting_lines_cogs
    sql_table: gpc.transaction_accounting_lines_cogs
    title: COGS Accounting Lines
    description: GL-based COGS from TransactionAccountingLine (accurate source of truth for cost of goods sold) - using external parquet table

    # Joins to transaction_lines for additional dimensions if needed
    joins:
      - name: transaction_lines
        relationship: many_to_one
        sql: "{CUBE}.transaction = {transaction_lines}.transaction"

    dimensions:
      - name: id
        sql: "CONCAT(CAST({CUBE}.transaction AS STRING), '-', CAST({CUBE}.id AS STRING))"
        type: string
        primary_key: true
        description: Composite primary key (transaction-id)

      - name: transaction_id
        sql: "{CUBE}.transaction"
        type: number
        description: Transaction ID (for JOIN to transaction_lines)

      - name: transactionline_id
        sql: "{CUBE}.transactionline"
        type: number
        description: Transaction line ID

      - name: transaction_date
        sql: "CAST({CUBE}.trandate AS TIMESTAMP)"
        type: time
        description: Transaction date

      - name: account_id
        sql: "{CUBE}.account"
        type: number
        description: COGS account ID

      - name: account_name
        sql: account_name
        type: string
        description: COGS account name

      - name: acctnumber
        sql: acctnumber
        type: number
        description: COGS account number

      - name: accttype
        sql: accttype
        type: string
        description: Account type (should be COGS)

    measures:
      - name: gl_cogs
        sql: debit
        type: sum
        format: currency
        description: "GL-based COGS (sum of all COGS account debit postings) - ACCURATE source of truth, replaces corrupt total_cost field"

      - name: gl_cogs_debit
        sql: debit
        type: sum
        format: currency
        description: Total COGS debit amounts

      - name: gl_cogs_credit
        sql: credit
        type: sum
        format: currency
        description: Total COGS credit amounts

      - name: cogs_entry_count
        type: count
        description: Number of COGS GL entries

    pre_aggregations:
      - name: cogs_by_account
        measures:
          - gl_cogs
          - gl_cogs_debit
          - gl_cogs_credit
          - cogs_entry_count
        dimensions:
          - account_name
          - acctnumber
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day

      # Monthly rollup for faster queries
      - name: cogs_monthly_totals
        measures:
          - gl_cogs
          - cogs_entry_count
        time_dimension: transaction_date
        granularity: month
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
