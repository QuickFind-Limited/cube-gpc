cubes:
  - name: supplier_lead_times
    sql_table: gpc.item_receipt_lines

    title: Supplier Lead Times
    description: PO to receipt lead time analysis using createdfrom linkage. Excludes landed costs and outliers (>365 days).

    measures:
      - name: avg_lead_time_days
        sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY)"
        type: avg
        description: Average lead time in days from PO date to receipt date
        filters:
          - sql: "{CUBE}.createdfrom IS NOT NULL"
          - sql: "{CUBE}.mainline = 'F'"
          - sql: "{CUBE}.item IS NOT NULL"
          - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) BETWEEN 0 AND 365"

      - name: min_lead_time_days
        sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY)"
        type: min
        description: Minimum lead time in days
        filters:
          - sql: "{CUBE}.createdfrom IS NOT NULL"
          - sql: "{CUBE}.mainline = 'F'"
          - sql: "{CUBE}.item IS NOT NULL"
          - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) BETWEEN 0 AND 365"

      - name: max_lead_time_days
        sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY)"
        type: max
        description: Maximum lead time in days
        filters:
          - sql: "{CUBE}.createdfrom IS NOT NULL"
          - sql: "{CUBE}.mainline = 'F'"
          - sql: "{CUBE}.item IS NOT NULL"
          - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) BETWEEN 0 AND 365"

      - name: receipt_count
        type: count
        description: Number of receipts for lead time analysis
        filters:
          - sql: "{CUBE}.createdfrom IS NOT NULL"
          - sql: "{CUBE}.mainline = 'F'"
          - sql: "{CUBE}.item IS NOT NULL"
          - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) BETWEEN 0 AND 365"

      - name: total_qty_received
        sql: quantity
        type: sum
        description: Total quantity received
        filters:
          - sql: "{CUBE}.createdfrom IS NOT NULL"
          - sql: "{CUBE}.mainline = 'F'"
          - sql: "{CUBE}.item IS NOT NULL"
          - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) BETWEEN 0 AND 365"

    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
        public: false

      - name: supplier_id
        sql: "{source_purchase_orders}.entity"
        type: number
        title: Supplier ID
        description: Vendor entity ID

      - name: item
        sql: item
        type: number
        title: Item ID
        description: Item ID for item-level lead time analysis

      - name: lead_time_days
        sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY)"
        type: number
        title: Lead Time (Days)
        description: Days from PO to receipt

      - name: receipt_date
        sql: "{item_receipts}.trandate"
        type: time
        title: Receipt Date
        description: Date of item receipt

      - name: po_date
        sql: "{source_purchase_orders}.trandate"
        type: time
        title: PO Date
        description: Purchase order date

      - name: po_number
        sql: "{source_purchase_orders}.tranid"
        type: string
        title: PO Number
        description: Purchase order transaction number

      - name: receipt_number
        sql: "{item_receipts}.tranid"
        type: string
        title: Receipt Number
        description: Item receipt transaction number

      # Lead time bucketing for analysis
      - name: lead_time_bucket
        type: string
        title: Lead Time Range
        description: Bucketed lead time ranges
        case:
          when:
            - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) <= 7"
              label: "0-7 days"
            - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) <= 14"
              label: "8-14 days"
            - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) <= 30"
              label: "15-30 days"
            - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) <= 60"
              label: "31-60 days"
            - sql: "DATE_DIFF(CAST({item_receipts}.trandate AS DATE), CAST({source_purchase_orders}.trandate AS DATE), DAY) <= 90"
              label: "61-90 days"
          else:
            label: "90+ days"

    joins:
      - name: item_receipts
        relationship: many_to_one
        sql: "CAST({CUBE}.transaction AS INT64) = CAST({item_receipts}.id AS INT64)"

      - name: source_purchase_orders
        relationship: many_to_one
        sql: "CAST({CUBE}.createdfrom AS INT64) = CAST({source_purchase_orders}.id AS INT64)"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items}.id"

    pre_aggregations:
      - name: lead_time_rollup
        measures:
          - receipt_count
          - total_qty_received
          - avg_lead_time_days
          - min_lead_time_days
          - max_lead_time_days
        dimensions:
          - supplier_id
          - item
          - lead_time_bucket
        refresh_key:
          every: 1 day
        partition_granularity: month
        time_dimension: receipt_date
        build_range_start:
          sql: SELECT DATE_SUB(CURRENT_DATE(), INTERVAL 24 MONTH)
        build_range_end:
          sql: SELECT CURRENT_DATE()
