cubes:
  - name: on_order_inventory
    sql_table: gpc.purchase_order_lines

    title: On-Order Inventory
    description: Real-time outstanding PO quantities by item (calculated from open POs)

    measures:
      - name: total_on_order_units
        sql: "quantity - COALESCE(quantityshiprecv, 0)"
        type: sum
        description: Total units on order across all open POs
        filters:
          - sql: "{purchase_orders}.status IN ('B', 'D', 'E')"
          - sql: "{CUBE}.quantity - COALESCE({CUBE}.quantityshiprecv, 0) > 0"

      - name: on_order_value
        sql: "(quantity - COALESCE(quantityshiprecv, 0)) * unit_cost"
        type: sum
        format: currency
        description: Total value of on-order inventory
        filters:
          - sql: "{purchase_orders}.status IN ('B', 'D', 'E')"
          - sql: "{CUBE}.quantity - COALESCE({CUBE}.quantityshiprecv, 0) > 0"

      - name: avg_on_order_per_item
        sql: "quantity - COALESCE(quantityshiprecv, 0)"
        type: avg
        description: Average units on order per item
        filters:
          - sql: "{purchase_orders}.status IN ('B', 'D', 'E')"
          - sql: "{CUBE}.quantity - COALESCE({CUBE}.quantityshiprecv, 0) > 0"

      - name: open_po_count
        sql: po_id
        type: count_distinct
        description: Total number of open POs
        filters:
          - sql: "{purchase_orders}.status IN ('B', 'D', 'E')"
          - sql: "{CUBE}.quantity - COALESCE({CUBE}.quantityshiprecv, 0) > 0"

      - name: item_count
        sql: item
        type: count_distinct
        description: Number of unique items with on-order inventory
        filters:
          - sql: "{purchase_orders}.status IN ('B', 'D', 'E')"
          - sql: "{CUBE}.quantity - COALESCE({CUBE}.quantityshiprecv, 0) > 0"

      - name: avg_pos_per_item
        sql: po_id
        type: count_distinct
        description: Number of open POs (for averaging per item)
        filters:
          - sql: "{purchase_orders}.status IN ('B', 'D', 'E')"
          - sql: "{CUBE}.quantity - COALESCE({CUBE}.quantityshiprecv, 0) > 0"

    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
        public: false

      - name: item
        sql: item
        type: number
        title: Item ID
        description: NetSuite item ID

      - name: itemid
        sql: "{items}.itemid"
        type: string
        title: SKU
        description: Item SKU/ID

      - name: displayname
        sql: "{items}.displayname"
        type: string
        title: Product Name
        description: Item display name

      - name: qty_on_order
        sql: "quantity - COALESCE(quantityshiprecv, 0)"
        type: number
        title: Units On Order
        description: Units on order for this line

    joins:
      - name: purchase_orders
        relationship: many_to_one
        sql: "{CUBE}.po_id = {purchase_orders}.id"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items}.id"

    pre_aggregations:
      - name: on_order_rollup
        measures:
          - total_on_order_units
          - on_order_value
          - open_po_count
          - item_count
        dimensions:
          - item
          - itemid
          - displayname
          - purchase_orders.status
        time_dimension: purchase_orders.trandate
        granularity: day
        partition_granularity: month
        refresh_key:
          every: 1 hour
        build_range_start:
          sql: SELECT DATE_SUB(CURRENT_DATE(), INTERVAL 12 MONTH)
        build_range_end:
          sql: SELECT CURRENT_DATE()
