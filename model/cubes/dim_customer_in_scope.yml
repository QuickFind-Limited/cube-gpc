cubes:
  - name: dim_customer_in_scope
    sql: SELECT * FROM gpc_data_2026_01_26.dim_customer_in_scope
    title: Customers (In-Scope)
    description: >
      Pre-filtered customer dimension containing only in-scope customers (excludes webstore, POS, and test entities).
      Grain: one row per in-scope customer.

    measures:
      - name: customer_count
        type: count
        description: Total number of in-scope customers

      - name: active_customer_count
        type: count
        sql: "{CUBE}.customer_id"
        filters:
          - sql: "{CUBE}.is_inactive = false"
        description: Count of active (non-inactive) customers

      - name: person_customer_count
        type: count
        sql: "{CUBE}.customer_id"
        filters:
          - sql: "{CUBE}.is_person = true"
        description: Count of individual person customers

      - name: company_customer_count
        type: count
        sql: "{CUBE}.customer_id"
        filters:
          - sql: "{CUBE}.is_person = false"
        description: Count of company/business customers

    dimensions:
      - name: customer_id
        sql: "{CUBE}.customer_id"
        type: number
        primary_key: true
        description: Unique identifier for the customer

      - name: customer_code
        sql: "{CUBE}.customer_code"
        type: string
        description: Customer code or external reference number

      - name: company_name
        sql: "{CUBE}.company_name"
        type: string
        description: Company name (for business customers)

      - name: first_name
        sql: "{CUBE}.first_name"
        type: string
        description: First name (for individual customers)

      - name: last_name
        sql: "{CUBE}.last_name"
        type: string
        description: Last name (for individual customers)

      - name: full_name
        sql: "CASE WHEN {CUBE}.is_person THEN CONCAT(COALESCE({CUBE}.first_name, ''), ' ', COALESCE({CUBE}.last_name, '')) ELSE {CUBE}.company_name END"
        type: string
        description: Full name (combined first/last for persons, company name for businesses)

      - name: email
        sql: "{CUBE}.email"
        type: string
        description: Customer email address

      - name: phone
        sql: "{CUBE}.phone"
        type: string
        description: Customer phone number

      - name: entity_type
        sql: "{CUBE}.entity_type"
        type: string
        description: Entity type classification (customer, webstore, pos)

      - name: is_test_entity
        sql: "{CUBE}.is_test_entity"
        type: boolean
        description: True if this is a test entity (should be false for in-scope customers)

      - name: customer_in_scope
        sql: "{CUBE}.customer_in_scope"
        type: boolean
        description: True if customer is in scope for analytics (should be true for all rows)

      - name: subsidiary_id
        sql: "{CUBE}.subsidiary_id"
        type: number
        description: Foreign key to subsidiary dimension

      - name: category_id
        sql: "{CUBE}.category_id"
        type: number
        description: Foreign key to customer category dimension

      - name: is_inactive
        sql: "{CUBE}.is_inactive"
        type: boolean
        description: True if customer account is inactive

      - name: is_person
        sql: "{CUBE}.is_person"
        type: boolean
        description: True if customer is an individual person, false if business entity

      - name: date_created
        sql: "TIMESTAMP({CUBE}.date_created)"
        type: time
        description: Date when customer record was created

      - name: last_modified_date
        sql: "TIMESTAMP({CUBE}.last_modified_date)"
        type: time
        description: Date when customer record was last modified

    segments:
      - name: active_only
        sql: "{CUBE}.is_inactive = false"
        description: "Excludes inactive customers"

      - name: inactive_only
        sql: "{CUBE}.is_inactive = true"
        description: "Only inactive customers"

      - name: persons_only
        sql: "{CUBE}.is_person = true"
        description: "Individual person customers only"

      - name: companies_only
        sql: "{CUBE}.is_person = false"
        description: "Business/company customers only"

      - name: real_customers
        sql: "{CUBE}.entity_type = 'customer' AND {CUBE}.is_test_entity = false"
        description: "Real customers only (excludes any remaining test entities)"

      - name: has_email
        sql: "{CUBE}.email IS NOT NULL AND {CUBE}.email != ''"
        description: "Customers with email address on file"

      - name: has_phone
        sql: "{CUBE}.phone IS NOT NULL AND {CUBE}.phone != ''"
        description: "Customers with phone number on file"
