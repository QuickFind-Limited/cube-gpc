cubes:
  - name: transaction_lines
    sql: SELECT * FROM transaction_lines
    title: Transaction Lines
    description: Line items from all transactions - the main fact table for metrics

    joins:
      - name: transactions
        relationship: many_to_one
        sql: "{CUBE}.transaction = {transactions.id}"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.id}"

      - name: locations
        relationship: many_to_one
        sql: "{CUBE}.location = {locations.id}"

      - name: departments
        relationship: many_to_one
        sql: "{CUBE}.department = {departments.id}"

      - name: classifications
        relationship: many_to_one
        sql: "{CUBE}.class = {classifications.id}"

    measures:
      # Revenue Measures - Rule 5: CustInvc + CashSale only
      # Currency conversion: GBP (currency=4) converted to EUR at 1.13528
      - name: total_revenue
        sql: >
          CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN
            CASE
              WHEN {transactions.currency} = 4 THEN {CUBE}.amount * -1 * 1.13528
              ELSE {CUBE}.amount * -1
            END
          ELSE 0 END
        type: sum
        format: currency
        description: Total gross revenue in EUR (CustInvc + CashSale only, GBP converted)
        drill_members:
          - transactions.trandate
          - items.itemid
          - items.displayname
          - locations.name

      - name: net_revenue
        sql: >
          CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN
            CASE
              WHEN {transactions.currency} = 4 THEN ({CUBE}.amount - COALESCE({CUBE}.taxamount, 0)) * -1 * 1.13528
              ELSE ({CUBE}.amount - COALESCE({CUBE}.taxamount, 0)) * -1
            END
          ELSE 0 END
        type: sum
        format: currency
        description: Net revenue in EUR (amount minus tax, GBP converted)

      # Units Measures - Rule 2: Sales quantities are negative
      - name: units_sold
        sql: "CAST(CASE WHEN {CUBE}.quantity < 0 THEN {CUBE}.quantity * -1 ELSE 0 END AS DOUBLE)"
        type: sum
        description: Total units sold (uses CASE per Rule 2)
        drill_members:
          - transactions.trandate
          - items.itemid
          - items.displayname
          - items.category

      - name: units_returned
        sql: "CAST(CASE WHEN {CUBE}.quantity > 0 THEN {CUBE}.quantity ELSE 0 END AS DOUBLE)"
        type: sum
        description: Total units returned

      # Tax Measures
      - name: total_tax
        sql: "{CUBE}.taxamount"
        type: sum
        format: currency
        description: Total tax amount

      # Discount Measures (calculated from baseprice vs rate)
      - name: total_discount
        sql: "SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {items.base_price} > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ({items.base_price} - {CUBE}.rate) * ABS({CUBE}.quantity) ELSE 0 END)"
        type: number
        format: currency
        description: Total discount amount (baseprice - rate) for DM001

      - name: discount_rate
        sql: "100.0 * SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {items.base_price} > 0 AND {CUBE}.quantity < 0 THEN ({items.base_price} - {CUBE}.rate) * ABS({CUBE}.quantity) ELSE 0 END) / NULLIF(SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {CUBE}.quantity < 0 THEN {items.base_price} * ABS({CUBE}.quantity) ELSE 0 END), 0)"
        type: number
        description: Average discount rate percentage for DM002

      - name: discounted_units
        sql: "SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {items.base_price} > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ABS({CUBE}.quantity) ELSE 0 END)"
        type: number
        description: Units sold at discount for DM058

      # Count Measures
      - name: line_count
        type: count
        description: Total number of line items

      - name: transaction_count
        sql: "{CUBE}.transaction"
        type: count_distinct
        description: Number of unique transactions

      - name: sku_count
        sql: "{CUBE}.item"
        type: count_distinct
        description: Number of unique SKUs

      # Calculated Measures
      - name: average_order_value
        sql: "1.0 * {total_revenue} / NULLIF({transaction_count}, 0)"
        type: number
        format: currency
        description: Average order value (AOV) - revenue transactions only

      - name: average_salesord_value
        sql: "1.0 * SUM(CASE WHEN {transactions.type} = 'SalesOrd' THEN {CUBE}.amount * -1 ELSE 0 END) / NULLIF(COUNT(DISTINCT CASE WHEN {transactions.type} = 'SalesOrd' THEN {CUBE}.transaction END), 0)"
        type: number
        format: currency
        description: Average order value from SalesOrd (OM003 - order intent)

      - name: average_items_per_order
        sql: "1.0 * {line_count} / NULLIF({transaction_count}, 0)"
        type: number
        description: Average number of items per order


      - name: average_selling_price
        sql: "1.0 * {total_revenue} / NULLIF({units_sold}, 0)"
        type: number
        format: currency
        description: Average selling price per unit

      # Margin Measures for MM001
      - name: total_cost
        sql: "CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN {CUBE}.costestimate * -1 ELSE 0 END"
        type: sum
        format: currency
        description: Total cost estimate

      - name: gross_margin
        sql: >
          CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN
            CASE
              WHEN {transactions.currency} = 4 THEN ({CUBE}.amount * -1 * 1.13528) - (COALESCE({CUBE}.costestimate, 0) * -1)
              ELSE ({CUBE}.amount * -1) - (COALESCE({CUBE}.costestimate, 0) * -1)
            END
          ELSE 0 END
        type: sum
        format: currency
        description: Gross margin in EUR (revenue - cost, GBP converted)

      - name: gross_margin_percent
        sql: "100.0 * (({total_revenue}) - ({total_cost})) / NULLIF({total_revenue}, 0)"
        type: number
        description: Gross margin percentage

      - name: units_per_week
        sql: "1.0 * {units_sold} / NULLIF(DATE_DIFF('week', MIN({transactions.trandate}), MAX({transactions.trandate})) + 1, 0)"
        type: number
        description: Sales velocity - units sold per week (LIFE004)

      # YoY Comparison for RM003
      - name: prior_year_revenue
        sql: >
          CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale')
            AND {transactions.trandate} >= DATE_ADD(DATE_TRUNC('year', CURRENT_DATE), INTERVAL -1 YEAR)
            AND {transactions.trandate} < DATE_TRUNC('year', CURRENT_DATE) THEN
            CASE
              WHEN {transactions.currency} = 4 THEN {CUBE}.amount * -1 * 1.13528
              ELSE {CUBE}.amount * -1
            END
          ELSE 0 END
        type: sum
        format: currency
        description: Revenue from prior year in EUR for YoY comparison (RM003)

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: transaction
        sql: "{CUBE}.transaction"
        type: number

      - name: item
        sql: "{CUBE}.item"
        type: number

      - name: location
        sql: "{CUBE}.location"
        type: number

      - name: quantity
        sql: "{CUBE}.quantity"
        type: number

      - name: amount
        sql: "{CUBE}.amount"
        type: number

      - name: rate
        sql: "{CUBE}.rate"
        type: number
        description: Unit rate

      - name: costestimate
        sql: "{CUBE}.costestimate"
        type: number
        description: Cost estimate for margin calculations

      - name: mainline
        sql: "{CUBE}.mainline"
        type: string
        description: "Mainline flag: T for header, F for detail lines"

      - name: class
        sql: "{CUBE}.class"
        type: number
        description: Classification ID

      - name: department
        sql: "{CUBE}.department"
        type: number

      # Use locations.channel_type instead of computed dimension
      # Use departments.name for department analysis
      # Use classifications.name for classification analysis

    segments:
      - name: sales_lines
        sql: "{CUBE}.quantity < 0"

      - name: return_lines
        sql: "{CUBE}.quantity > 0"
