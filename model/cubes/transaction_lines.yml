cubes:
  - name: transaction_lines
    sql: SELECT * FROM transaction_lines
    title: Transaction Lines
    description: Line items from all transactions - the main fact table for metrics

    joins:
      - name: transactions
        relationship: many_to_one
        sql: "{CUBE}.transaction = {transactions.id}"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.id}"

      - name: locations
        relationship: many_to_one
        sql: "{CUBE}.location = {locations.id}"

      - name: departments
        relationship: many_to_one
        sql: "{CUBE}.department = {departments.id}"

      - name: classifications
        relationship: many_to_one
        sql: "{CUBE}.class = {classifications.id}"

    measures:
      # Revenue Measures - Rule 5: CustInvc + CashSale only
      - name: total_revenue
        sql: "CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN {CUBE}.amount * -1 ELSE 0 END"
        type: sum
        format: currency
        description: Total gross revenue (CustInvc + CashSale only)
        drill_members:
          - transactions.trandate
          - items.itemid
          - items.displayname
          - locations.name

      - name: net_revenue
        sql: "CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN ({CUBE}.amount - COALESCE({CUBE}.taxamount, 0)) * -1 ELSE 0 END"
        type: sum
        format: currency
        description: Net revenue (amount minus tax)

      # Units Measures - Rule 2: Sales quantities are negative
      - name: units_sold
        sql: "CAST(CASE WHEN {CUBE}.quantity < 0 THEN {CUBE}.quantity * -1 ELSE 0 END AS DOUBLE)"
        type: sum
        description: Total units sold (uses CASE per Rule 2)
        drill_members:
          - transactions.trandate
          - items.itemid
          - items.displayname
          - items.category

      - name: units_returned
        sql: "CAST(CASE WHEN {CUBE}.quantity > 0 THEN {CUBE}.quantity ELSE 0 END AS DOUBLE)"
        type: sum
        description: Total units returned

      # Tax Measures
      - name: total_tax
        sql: "{CUBE}.taxamount"
        type: sum
        format: currency
        description: Total tax amount

      # Discount Measures (calculated from baseprice vs rate)
      - name: total_discount
        sql: "SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {items.base_price} > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ({items.base_price} - {CUBE}.rate) * ABS({CUBE}.quantity) ELSE 0 END)"
        type: number
        format: currency
        description: Total discount amount (baseprice - rate) for DM001

      - name: discount_rate
        sql: "100.0 * SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {items.base_price} > 0 AND {CUBE}.quantity < 0 THEN ({items.base_price} - {CUBE}.rate) * ABS({CUBE}.quantity) ELSE 0 END) / NULLIF(SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {CUBE}.quantity < 0 THEN {items.base_price} * ABS({CUBE}.quantity) ELSE 0 END), 0)"
        type: number
        description: Average discount rate percentage for DM002

      - name: discounted_units
        sql: "SUM(CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {items.base_price} > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ABS({CUBE}.quantity) ELSE 0 END)"
        type: number
        description: Units sold at discount for DM058

      # Count Measures
      - name: line_count
        type: count
        description: Total number of line items

      - name: transaction_count
        sql: "{CUBE}.transaction"
        type: count_distinct
        description: Number of unique transactions

      - name: sku_count
        sql: "{CUBE}.item"
        type: count_distinct
        description: Number of unique SKUs

      # Calculated Measures
      - name: average_order_value
        sql: "1.0 * {total_revenue} / NULLIF({transaction_count}, 0)"
        type: number
        format: currency
        description: Average order value (AOV) - revenue transactions only

      - name: average_salesord_value
        sql: "1.0 * SUM(CASE WHEN {transactions.type} = 'SalesOrd' THEN {CUBE}.amount * -1 ELSE 0 END) / NULLIF(COUNT(DISTINCT CASE WHEN {transactions.type} = 'SalesOrd' THEN {CUBE}.transaction END), 0)"
        type: number
        format: currency
        description: Average order value from SalesOrd (OM003 - order intent)

      - name: average_items_per_order
        sql: "1.0 * {line_count} / NULLIF({transaction_count}, 0)"
        type: number
        description: Average number of items per order


      - name: average_selling_price
        sql: "1.0 * {total_revenue} / NULLIF({units_sold}, 0)"
        type: number
        format: currency
        description: Average selling price per unit

      # Margin Measures for MM001
      - name: total_cost
        sql: "CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN {CUBE}.costestimate ELSE 0 END"
        type: sum
        format: currency
        description: Total cost estimate

      - name: gross_margin
        sql: "CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') THEN ({CUBE}.amount * -1) - COALESCE({CUBE}.costestimate, 0) ELSE 0 END"
        type: sum
        format: currency
        description: Gross margin (revenue - cost)

      - name: gross_margin_percent
        sql: "100.0 * (({total_revenue}) - ({total_cost})) / NULLIF({total_revenue}, 0)"
        type: number
        description: Gross margin percentage

      - name: units_per_week
        sql: "1.0 * {units_sold} / NULLIF(DATE_DIFF('week', MIN({transactions.trandate}), MAX({transactions.trandate})) + 1, 0)"
        type: number
        description: Sales velocity - units sold per week (LIFE004)

      # YoY Comparison for RM003
      - name: prior_year_revenue
        sql: "CASE WHEN {transactions.type} IN ('CustInvc', 'CashSale') AND {transactions.trandate} >= DATE_ADD(DATE_TRUNC('year', CURRENT_DATE), INTERVAL -1 YEAR) AND {transactions.trandate} < DATE_TRUNC('year', CURRENT_DATE) THEN {CUBE}.amount * -1 ELSE 0 END"
        type: sum
        format: currency
        description: Revenue from prior year for YoY comparison (RM003)

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: transaction
        sql: "{CUBE}.transaction"
        type: number

      - name: item
        sql: "{CUBE}.item"
        type: number

      - name: location
        sql: "{CUBE}.location"
        type: number

      - name: quantity
        sql: "{CUBE}.quantity"
        type: number

      - name: amount
        sql: "{CUBE}.amount"
        type: number

      - name: rate
        sql: "{CUBE}.rate"
        type: number
        description: Unit rate

      - name: costestimate
        sql: "{CUBE}.costestimate"
        type: number
        description: Cost estimate for margin calculations

      - name: mainline
        sql: "{CUBE}.mainline"
        type: string
        description: "Mainline flag: T for header, F for detail lines"

      - name: class
        sql: "{CUBE}.class"
        type: number
        description: Classification ID

      - name: department
        sql: "{CUBE}.department"
        type: number

      # Channel type with John Lewis PARTNER detection (Golden Rule 4 + PARTNER fix)
      - name: channel_type
        sql: >
          CASE
            WHEN {transactions.remote_order_source} = 'John Lewis' THEN 'PARTNER'
            WHEN {locations.name} IS NULL THEN 'D2C'
            WHEN {locations.name} LIKE 'Bleckmann%' AND {locations.name} NOT LIKE '%Quarantine%' AND {locations.name} NOT LIKE '%Miscellaneous%' THEN 'D2C'
            WHEN {locations.name} IN ('Meteor Space', '2Flow') THEN 'D2C'
            WHEN {locations.name} IN (
              'Dundrum Town Centre', 'Mahon Point', 'Crescent Centre', 'Liffey Valley',
              'Kildare Village', 'Blanchardstown Centre', 'Galway', 'Swords Pavillon', 'Jervis Centre',
              'Westfield London', 'Manchester', 'Belfast', 'Liverpool'
            ) THEN 'RETAIL'
            WHEN {locations.name} LIKE 'Wholesale%' THEN 'B2B_WHOLESALE'
            WHEN {locations.name} LIKE 'Lifestyle Sports%' AND {locations.name} NOT LIKE '%Quarantine%' THEN 'B2B_WHOLESALE'
            WHEN {locations.name} IN ('Otrium', 'The Very Group', 'Digme', 'Academy Crests') THEN 'PARTNER'
            WHEN {locations.name} LIKE 'Events%' THEN 'EVENTS'
            ELSE 'OTHER'
          END
        type: string
        description: "Channel type with John Lewis detection: D2C, RETAIL, B2B_WHOLESALE, PARTNER, EVENTS, OTHER"

      # Department name for POS vs Online analysis
      - name: department_name
        sql: "{departments.name}"
        type: string
        description: "Department name: eCommerce, Retail, Wholesale"

      # Classification name for specific location/website
      - name: classification_name
        sql: "{classifications.name}"
        type: string
        description: "Classification: EU Website, UK Website, Kildare Village, etc."

      # POS vs Online derived dimension
      - name: pos_vs_online
        sql: >
          CASE
            WHEN {departments.name} = 'eCommerce' THEN 'Online'
            WHEN {departments.name} = 'Retail' THEN 'POS'
            ELSE 'Other'
          END
        type: string
        description: "POS vs Online classification based on department"

    segments:
      - name: sales_lines
        sql: "{CUBE}.quantity < 0"

      - name: return_lines
        sql: "{CUBE}.quantity > 0"
