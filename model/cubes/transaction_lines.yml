cubes:
  - name: transaction_lines
    sql: >
      SELECT
        tl.*,
        t.type as transaction_type,
        t.currency as transaction_currency,
        t.trandate as transaction_date,
        t.status as transaction_status,
        t.subsidiary as transaction_subsidiary,
        t.custbody_customer_email as customer_email,
        t.billing_country,
        t.shipping_country,
        l.name as location_name,
        CASE
          WHEN l.name IS NULL THEN 'D2C'
          WHEN l.name LIKE 'Bleckmann%' AND l.name NOT LIKE '%Quarantine%' AND l.name NOT LIKE '%Miscellaneous%' THEN 'D2C'
          WHEN l.name IN ('Meteor Space', '2Flow') THEN 'D2C'
          WHEN l.name IN ('Dundrum Town Centre', 'Mahon Point', 'Crescent Centre', 'Liffey Valley', 'Kildare Village', 'Blanchardstown Centre', 'Galway', 'Swords Pavillon', 'Jervis Centre', 'Westfield London', 'Manchester', 'Belfast', 'Liverpool') THEN 'RETAIL'
          WHEN l.name LIKE 'Wholesale%' THEN 'B2B_WHOLESALE'
          WHEN l.name LIKE 'Lifestyle Sports%' AND l.name NOT LIKE '%Quarantine%' THEN 'B2B_WHOLESALE'
          WHEN l.name IN ('Otrium', 'The Very Group', 'Digme', 'Academy Crests') THEN 'PARTNER'
          WHEN l.name LIKE 'Events%' THEN 'EVENTS'
          ELSE 'OTHER'
        END as channel_type,
        i.itemid as sku,
        i.displayname as product_name,
        i.custitem_gpc_category as category,
        i.custitem_gpc_season as season,
        i.custitem_gpc_size as size,
        i.custitem_gpc_range as product_range,
        i.custitem_gpc_collection as collection,
        i.custitem_gpc_child_colour as color,
        i.baseprice as item_base_price,
        d.name as department_name,
        c.name as classification_name
      FROM gpc.transaction_lines_clean tl
      LEFT JOIN gpc.transactions_clean t ON tl.transaction = t.id
      LEFT JOIN gpc.locations l ON tl.location = l.id
      LEFT JOIN gpc.items i ON tl.item = i.id
      LEFT JOIN gpc.departments d ON tl.department = d.id
      LEFT JOIN gpc.classifications c ON tl.class = c.id
    title: Transaction Lines
    description: Line items from all transactions - the main fact table for metrics (denormalized)

    joins:
      - name: transactions
        relationship: many_to_one
        sql: "{CUBE}.transaction = {transactions.id}"

    measures:
      # Revenue Measures - Rule 5: CustInvc + CashSale only
      # Currency conversion: GBP (currency=4) converted to EUR at 1.13528
      - name: total_revenue
        sql: >
          CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN
            CASE
              WHEN {CUBE}.transaction_currency = 4 THEN {CUBE}.amount * -1 * 1.13528
              ELSE {CUBE}.amount * -1
            END
          ELSE 0 END AS FLOAT64)
        type: sum
        format: currency
        description: Total gross revenue in EUR (CustInvc + CashSale only, GBP converted)

      - name: net_revenue
        sql: >
          CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN
            CASE
              WHEN {CUBE}.transaction_currency = 4 THEN ({CUBE}.amount * -1 * 1.13528) - COALESCE({CUBE}.taxamount, 0)
              ELSE ({CUBE}.amount * -1) - COALESCE({CUBE}.taxamount, 0)
            END
          ELSE 0 END AS FLOAT64)
        type: sum
        format: currency
        description: Net revenue in EUR (gross revenue minus tax, GBP converted)

      # Units Measures - Rule 2: Sales quantities are negative
      - name: units_sold
        sql: "CAST(CASE WHEN {CUBE}.quantity < 0 THEN {CUBE}.quantity * -1 ELSE 0 END AS FLOAT64)"
        type: sum
        description: Total units sold (uses CASE per Rule 2)

      - name: units_returned
        sql: "CAST(CASE WHEN {CUBE}.quantity > 0 THEN {CUBE}.quantity ELSE 0 END AS FLOAT64)"
        type: sum
        description: Total units returned

      # Tax Measures
      - name: total_tax
        sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN {CUBE}.taxamount ELSE 0 END AS FLOAT64)"
        type: sum
        format: currency
        description: Total tax amount (CustInvc + CashSale only)

      # Discount Measures (calculated from baseprice vs rate)
      - name: total_discount
        sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.item_base_price > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ({CUBE}.item_base_price - {CUBE}.rate) * ABS({CUBE}.quantity) ELSE 0 END AS FLOAT64)"
        type: sum
        format: currency
        description: Total discount amount (baseprice - rate) for DM001

      # Component measures for discount_rate calculation (DM002)
      - name: total_discount_amount
        sql: "CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.item_base_price > 0 AND {CUBE}.quantity < 0 THEN ({CUBE}.item_base_price - {CUBE}.rate) * ABS({CUBE}.quantity) ELSE 0 END"
        type: sum
        format: currency
        description: Total discount amount for discount_rate calculation (additive component for DM002)

      - name: total_base_price_for_discount
        sql: "CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.quantity < 0 THEN {CUBE}.item_base_price * ABS({CUBE}.quantity) ELSE 0 END"
        type: sum
        format: currency
        description: Total base price for discount_rate calculation (additive component for DM002)

      - name: discount_rate
        sql: "100.0 * {total_discount_amount} / NULLIF({total_base_price_for_discount}, 0)"
        type: number
        description: Average discount rate percentage for DM002 (calculated from components - NOT for use in pre-aggs)

      - name: discounted_units
        sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.item_base_price > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ABS({CUBE}.quantity) ELSE 0 END AS FLOAT64)"
        type: sum
        description: Units sold at discount for DM058

      # Count Measures
      - name: line_count
        type: count
        description: Total number of line items

      - name: transaction_count
        sql: "{CUBE}.transaction"
        type: count_distinct
        description: Number of unique transactions

      - name: sku_count
        sql: "{CUBE}.item"
        type: count_distinct_approx
        description: Number of unique SKUs

      # Calculated Measures
      - name: average_order_value
        sql: "1.0 * {total_revenue} / NULLIF({transaction_count}, 0)"
        type: number
        format: currency
        description: Average order value (AOV) - revenue transactions only

      - name: average_salesord_value
        sql: "1.0 * SUM(CASE WHEN {CUBE}.transaction_type = 'SalesOrd' THEN {CUBE}.amount * -1 ELSE 0 END) / NULLIF(COUNT(DISTINCT CASE WHEN {CUBE}.transaction_type = 'SalesOrd' THEN {CUBE}.transaction END), 0)"
        type: number
        format: currency
        description: Average order value from SalesOrd (OM003 - order intent)

      - name: average_items_per_order
        sql: "1.0 * {line_count} / NULLIF({transaction_count}, 0)"
        type: number
        description: Average number of items per order

      - name: average_selling_price
        sql: "1.0 * {total_revenue} / NULLIF({units_sold}, 0)"
        type: number
        format: currency
        description: Average selling price per unit

      # Margin Measures for MM001
      - name: total_cost
        sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN {CUBE}.costestimate * -1 ELSE 0 END AS FLOAT64)"
        type: sum
        format: currency
        description: Total cost estimate

      - name: gross_margin
        sql: >
          CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN
            CASE
              WHEN {CUBE}.transaction_currency = 4 THEN ({CUBE}.amount * -1 * 1.13528) - (COALESCE({CUBE}.costestimate, 0) * -1)
              ELSE ({CUBE}.amount * -1) - (COALESCE({CUBE}.costestimate, 0) * -1)
            END
          ELSE 0 END AS FLOAT64)
        type: sum
        format: currency
        description: Gross margin in EUR (revenue - cost, GBP converted)

      - name: gross_margin_percent
        sql: "100.0 * (({total_revenue}) - ({total_cost})) / NULLIF({total_revenue}, 0)"
        type: number
        description: Gross margin percentage

      - name: min_transaction_date
        sql: "{CUBE}.transaction_date"
        type: min
        description: Earliest transaction date in result set

      - name: max_transaction_date
        sql: "{CUBE}.transaction_date"
        type: max
        description: Latest transaction date in result set

      - name: units_per_week
        sql: >
          1.0 * SUM(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.quantity < 0 THEN ABS({CUBE}.quantity) ELSE 0 END) /
          NULLIF(
            (MAX(CAST({CUBE}.transaction_date AS DATE)) - MIN(CAST({CUBE}.transaction_date AS DATE))) / 7.0 + 1,
            0
          )
        type: number
        description: Sales velocity - units sold per week (LIFE004)

      # Return rate for RET001
      - name: return_rate
        sql: "100.0 * {units_returned} / NULLIF({units_sold} + {units_returned}, 0)"
        type: number
        description: Return rate percentage (RET001)

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: transaction
        sql: "{CUBE}.transaction"
        type: number

      - name: item
        sql: "{CUBE}.item"
        type: number

      - name: location
        sql: "{CUBE}.location"
        type: number

      - name: quantity
        sql: "{CUBE}.quantity"
        type: number

      - name: amount
        sql: "{CUBE}.amount"
        type: number

      - name: rate
        sql: "{CUBE}.rate"
        type: number
        description: Unit rate

      - name: costestimate
        sql: "{CUBE}.costestimate"
        type: number
        description: Cost estimate for margin calculations

      - name: mainline
        sql: "{CUBE}.mainline"
        type: string
        description: "Mainline flag: T for header, F for detail lines"

      - name: class
        sql: "{CUBE}.class"
        type: number
        description: Classification ID

      - name: department
        sql: "{CUBE}.department"
        type: number

      # Denormalized dimensions from transactions
      - name: transaction_type
        sql: "{CUBE}.transaction_type"
        type: string
        description: "Transaction type: SalesOrd, CustInvc, CashSale"

      # Parameterized Time Dimension - Default: "Last 12 months"
      # Queries should include timeDimensions with dateRange parameter
      # Override by specifying different dateRange in query
      - name: transaction_date
        sql: "CAST({CUBE}.transaction_date AS TIMESTAMP)"
        type: time
        description: "Transaction date - PARAMETERIZED: Use timeDimensions with dateRange (default: 'last 12 months')"

      - name: month
        sql: "TIMESTAMP_TRUNC(CAST({CUBE}.transaction_date AS TIMESTAMP), MONTH)"
        type: time
        description: Transaction month

      - name: quarter
        sql: "TIMESTAMP_TRUNC(CAST({CUBE}.transaction_date AS TIMESTAMP), QUARTER)"
        type: time
        description: Transaction quarter

      - name: year
        sql: "TIMESTAMP_TRUNC(CAST({CUBE}.transaction_date AS TIMESTAMP), YEAR)"
        type: time
        description: Transaction year

      - name: week
        sql: "TIMESTAMP_TRUNC(CAST({CUBE}.transaction_date AS TIMESTAMP), WEEK)"
        type: time
        description: Transaction week

      - name: customer_email
        sql: "{CUBE}.customer_email"
        type: string
        description: Customer email address

      - name: billing_country
        sql: "{CUBE}.billing_country"
        type: string
        description: Billing country

      - name: shipping_country
        sql: "{CUBE}.shipping_country"
        type: string
        description: Shipping country

      # Denormalized dimensions from locations
      - name: location_name
        sql: "{CUBE}.location_name"
        type: string
        description: Location name

      - name: channel_type
        sql: "{CUBE}.channel_type"
        type: string
        description: "Channel type: D2C, RETAIL, B2B_WHOLESALE, PARTNER, EVENTS, OTHER"

      # Denormalized dimensions from items
      - name: sku
        sql: "{CUBE}.sku"
        type: string
        description: Item SKU code

      - name: product_name
        sql: "{CUBE}.product_name"
        type: string
        description: Product display name

      - name: category
        sql: "{CUBE}.category"
        type: string
        description: Product category

      - name: season
        sql: "{CUBE}.season"
        type: string
        description: Product season (e.g., AW25, SS24)

      - name: size
        sql: "{CUBE}.size"
        type: string
        description: Product size

      - name: product_range
        sql: "{CUBE}.product_range"
        type: string
        description: Product range

      - name: collection
        sql: "{CUBE}.collection"
        type: string
        description: Product collection

      - name: color
        sql: "{CUBE}.color"
        type: string
        description: Product color

      # Denormalized dimensions from departments/classifications
      - name: department_name
        sql: "{CUBE}.department_name"
        type: string
        description: Department name

      - name: classification_name
        sql: "{CUBE}.classification_name"
        type: string
        description: Classification name

    segments:
      - name: sales_lines
        sql: "{CUBE}.quantity < 0"

      - name: return_lines
        sql: "{CUBE}.quantity > 0"

      - name: revenue_transactions
        sql: "{CUBE}.transaction_type IN ('CustInvc', 'CashSale')"

    pre_aggregations:
      # Wide rollup covering most sales analysis queries
      - name: sales_analysis
        measures:
          - total_revenue
          - net_revenue
          - units_sold
          - units_returned
          - gross_margin
          - total_cost
          - total_tax
          - line_count
          - min_transaction_date
          - max_transaction_date
          - total_discount_amount
          - total_base_price_for_discount
          # Removed calculated/non-additive measures:
          # - transaction_count (count_distinct - doesn't work with dimensions)
          # - sku_count (count_distinct - doesn't work with dimensions)
          # - average_salesord_value (calculated - makes pre-agg non-additive)
          # - average_order_value (calculated - makes pre-agg non-additive)
          # - average_items_per_order (calculated - makes pre-agg non-additive)
          # - discount_rate (calculated - now use component measures instead)
        dimensions:
          - channel_type
          - category
          - season
          - department_name
          - billing_country
          - shipping_country
          - classification_name
          - transactions.currency
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        indexes:
          - name: channel_category_idx
            columns:
              - channel_type
              - category
        refresh_key:
          every: 24 hour

      # Product-level analysis
      - name: product_analysis
        measures:
          - total_revenue
          - units_sold
          - gross_margin
          - transaction_count
          - sku_count
        dimensions:
          - sku
          - product_name
          - category
          - season
          - size
          - color
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        indexes:
          - name: sku_idx
            columns:
              - sku
          - name: category_season_idx
            columns:
              - category
              - season
        refresh_key:
          every: 24 hour

      # Location-level analysis
      - name: location_analysis
        measures:
          - total_revenue
          - units_sold
          - transaction_count
          - gross_margin
        dimensions:
          - location_name
          - channel_type
          - department_name
          - classification_name
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        indexes:
          - name: location_name_idx
            columns:
              - location_name
        refresh_key:
          every: 24 hour

      # Daily granularity for recent trends
      - name: daily_metrics
        measures:
          - total_revenue
          - units_sold
          - transaction_count
        dimensions:
          - channel_type
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        refresh_key:
          every: 24 hour

      # Discount analysis
      - name: discount_analysis
        measures:
          - total_revenue
          - total_discount
          - discounted_units
          - units_sold
          - total_discount_amount
          - total_base_price_for_discount
          # Removed calculated measure:
          # - discount_rate (use component measures instead)
        dimensions:
          - channel_type
          - category
          - season
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        indexes:
          - name: channel_category_idx
            columns:
              - channel_type
              - category
        refresh_key:
          every: 24 hour

      # Customer geography analysis
      - name: customer_geography
        measures:
          - total_revenue
          - units_sold
          - transaction_count
        dimensions:
          - customer_email
          - billing_country
          - shipping_country
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        indexes:
          - name: country_idx
            columns:
              - billing_country
              - shipping_country
          - name: customer_email_idx
            columns:
              - customer_email
        refresh_key:
          every: 24 hour

      # Product range/collection analysis
      - name: product_range_analysis
        measures:
          - total_revenue
          - units_sold
          - gross_margin
          - min_transaction_date
          - max_transaction_date
          - units_per_week
        dimensions:
          - product_range
          - collection
          - category
          - season
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        indexes:
          - name: collection_range_idx
            columns:
              - collection
              - product_range
        refresh_key:
          every: 24 hour

      # Size/color by geography
      - name: size_geography
        measures:
          - units_sold
          - total_revenue
        dimensions:
          - size
          - color
          - billing_country
          - category
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        refresh_key:
          every: 24 hour

      # Transaction type breakdown
      - name: transaction_type_analysis
        measures:
          - total_revenue
          - units_sold
          - transaction_count
        dimensions:
          - transaction_type
          - channel_type
          - billing_country
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        refresh_key:
          every: 24 hour

      # Weekly trends
      - name: weekly_metrics
        measures:
          - total_revenue
          - units_sold
          - transaction_count
        dimensions:
          - channel_type
          - category
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        refresh_key:
          every: 24 hour

      # Yearly metrics for YoY comparisons
      - name: yearly_metrics
        measures:
          - total_revenue
          - units_sold
          - transaction_count
          - gross_margin
        dimensions:
          - channel_type
          - category
          - billing_country
        time_dimension: transaction_date
        granularity: day
        refresh_key:
          every: 24 hour

      # Product range analysis for LIFE004 (units_per_week)
      - name: product_range_analysis
        measures:
          - units_sold
          - min_transaction_date
          - max_transaction_date
          - total_revenue
          - total_discount
        dimensions:
          - product_range
          - category
          - season
        time_dimension: transaction_date
        granularity: day
        partition_granularity: month
        refresh_key:
          every: 24 hour
