cubes:
  - name: purchase_order_lines
    sql_table: gpc.purchase_order_lines

    title: Purchase Order Lines
    description: >
      Purchase order line items with quantity, cost, and receipt tracking.
      FIX (v68.8): Changed on_order_value and avg_unit_cost measures to reference 'rate' field directly instead of 'unit_cost' dimension name.
      FIX (v68.10): Added CAST to total_received_qty - quantityshiprecv is STRING type in typed Parquet.

    measures:
      - name: line_count
        type: count
        description: Number of PO line items

      - name: total_ordered_qty
        sql: quantity
        type: sum
        description: Total quantity ordered

      - name: total_received_qty
        sql: "CAST(quantityshiprecv AS INT64)"
        type: sum
        description: Total quantity received

      - name: total_outstanding_qty
        sql: "quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)"
        type: sum
        description: Outstanding quantity not yet received

      - name: total_po_line_value
        sql: line_total
        type: sum
        format: currency
        description: Total PO line value in base currency

      - name: on_order_value
        sql: "(quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)) * rate"
        type: sum
        format: currency
        description: Value of outstanding orders (qty outstanding * unit cost)

      - name: avg_unit_cost
        sql: rate
        type: avg
        format: currency
        description: Average unit cost

      - name: fulfillment_rate
        sql: "CASE WHEN quantity > 0 THEN (COALESCE(CAST(quantityshiprecv AS INT64), 0) / quantity) * 100 ELSE 0 END"
        type: avg
        format: percent
        description: Average fulfillment rate (received / ordered * 100)

      # SEA-003: In-Season Reorder Rate measures (NEW v71)
      - name: unique_items
        sql: item
        type: count_distinct_approx
        description: "SEA-003: Number of unique items ordered (approximate with HyperLogLog; rollup-safe)"

      - name: unique_pos
        sql: transaction
        type: count_distinct_approx
        description: "SEA-003: Number of unique purchase orders (approximate with HyperLogLog; rollup-safe)"

      # PO002 fix: Retail value measures using pricing table
      - name: on_order_retail_value
        sql: "(quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)) * {pricing.base_price_eur}"
        type: sum
        format: currency
        description: >
          Retail value of outstanding orders (qty outstanding * EUR base price).
          PO002 FIX - uses Pricing table for retail/selling prices. 99.7% PO item coverage.

      - name: total_retail_value
        sql: "quantity * {pricing.base_price_eur}"
        type: sum
        format: currency
        description: >
          Total retail value of ordered quantity (qty ordered * EUR base price).
          PO002 FIX - uses Pricing table for retail/selling prices.

    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
        public: false

      - name: po_id
        sql: transaction
        type: number
        title: Purchase Order ID
        description: Reference to purchase order header (transaction field)

      - name: item
        sql: item
        type: number
        title: Item ID
        description: NetSuite item ID

      - name: quantity
        sql: quantity
        type: number
        title: Quantity Ordered
        description: Quantity ordered on PO line

      - name: quantityshiprecv
        sql: quantityshiprecv
        type: number
        title: Quantity Received
        description: Quantity shipped/received

      - name: quantitybilled
        sql: quantitybilled
        type: number
        title: Quantity Billed
        description: Quantity billed

      - name: qty_outstanding
        sql: "quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)"
        type: number
        title: Quantity Outstanding
        description: Quantity not yet received

      - name: unit_cost
        sql: rate
        type: number
        format: currency
        title: Unit Cost
        description: Cost per unit in base currency (rate field)

      - name: trandate
        sql: "CAST({CUBE}.trandate AS TIMESTAMP)"
        type: time
        title: PO Date
        description: Purchase order transaction date (from header via denormalization)

      # SEA-003: Product attributes from items join (NEW v71)
      - name: season
        sql: "{items.season}"
        type: string
        title: Product Season
        description: "SEA-003: Product season code (e.g., AW24, SS25) from items table. Use for calculating in-season reorder rates."

      - name: category
        sql: "{items.category}"
        type: string
        title: Product Category
        description: "Product category from items table (Men, Women, Unisex, Accessories, etc.)"

      # PO002 fix: Country of origin and factory for PO analysis
      - name: country_of_origin
        sql: "{items.country_of_origin}"
        type: string
        title: Country of Origin
        description: >
          ISO 2-letter country of origin code from items table (e.g., CN=China, TR=Turkey, VN=Vietnam).
          86.6% coverage. PO002 FIX - enables PO analysis by sourcing country.

      - name: factory_code
        sql: "{vendors.factory_code}"
        type: string
        title: Factory Code
        description: >
          Supplier factory code from vendors table (e.g., CN0001, GB0021).
          Only manufacturing vendors have this (22 of 1,136). PO002 FIX.

      - name: supplier_company_name
        sql: "{vendors.company_name}"
        type: string
        title: Supplier Company Name
        description: >
          Supplier company name from vendors table (companyName). 99.7% coverage.
          PO002 FIX - alternative to vendor_name (entityId) for display.

    joins:
      - name: purchase_orders
        relationship: many_to_one
        sql: "{CUBE}.transaction = {purchase_orders}.id"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items}.id"

      - name: pricing
        relationship: many_to_one
        sql: "{CUBE}.item = {pricing}.item_id"

    pre_aggregations:
      - name: on_order_summary
        measures:
          - total_outstanding_qty
          - on_order_value
          - line_count
          - total_ordered_qty
          - total_received_qty
          - unique_items        # SEA-003 v71
          - unique_pos          # SEA-003 v71
          - on_order_retail_value   # PO002 fix - retail value
          - total_retail_value      # PO002 fix - retail value
        dimensions:
          - item
          - po_id               # SEA-003 v71
          - season              # SEA-003 v71
          - category            # SEA-003 v71
          - purchase_orders.supplier
          - vendors.vendor_name
          - country_of_origin       # PO002 fix - sourcing country from items
          - factory_code            # PO002 fix - factory code from vendors
          - supplier_company_name   # PO002 fix - company name from vendors
        time_dimension: trandate
        granularity: day
        refresh_key:
          every: 1 day
