cubes:
  - name: purchase_order_lines
    sql_table: gpc.purchase_order_lines

    title: Purchase Order Lines
    description: >
      Purchase order line items with quantity, cost, and receipt tracking.
      FIX (v68.8): Changed on_order_value and avg_unit_cost measures to reference 'rate' field directly instead of 'unit_cost' dimension name.
      FIX (v68.10): Added CAST to total_received_qty - quantityshiprecv is STRING type in typed Parquet.

    measures:
      - name: line_count
        type: count
        description: Number of PO line items

      - name: total_ordered_qty
        sql: quantity
        type: sum
        description: Total quantity ordered

      - name: total_received_qty
        sql: "CAST(quantityshiprecv AS INT64)"
        type: sum
        description: Total quantity received

      - name: total_outstanding_qty
        sql: "quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)"
        type: sum
        description: Outstanding quantity not yet received

      - name: total_po_line_value
        sql: line_total
        type: sum
        format: currency
        description: Total PO line value in base currency

      - name: on_order_value
        sql: "(quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)) * rate"
        type: sum
        format: currency
        description: Value of outstanding orders (qty outstanding * unit cost)

      - name: avg_unit_cost
        sql: rate
        type: avg
        format: currency
        description: Average unit cost

      - name: fulfillment_rate
        sql: "CASE WHEN quantity > 0 THEN (COALESCE(CAST(quantityshiprecv AS INT64), 0) / quantity) * 100 ELSE 0 END"
        type: avg
        format: percent
        description: Average fulfillment rate (received / ordered * 100)

    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
        public: false

      - name: po_id
        sql: transaction
        type: number
        title: Purchase Order ID
        description: Reference to purchase order header (transaction field)

      - name: item
        sql: item
        type: number
        title: Item ID
        description: NetSuite item ID

      - name: quantity
        sql: quantity
        type: number
        title: Quantity Ordered
        description: Quantity ordered on PO line

      - name: quantityshiprecv
        sql: quantityshiprecv
        type: number
        title: Quantity Received
        description: Quantity shipped/received

      - name: quantitybilled
        sql: quantitybilled
        type: number
        title: Quantity Billed
        description: Quantity billed

      - name: qty_outstanding
        sql: "quantity - COALESCE(CAST(quantityshiprecv AS INT64), 0)"
        type: number
        title: Quantity Outstanding
        description: Quantity not yet received

      - name: unit_cost
        sql: rate
        type: number
        format: currency
        title: Unit Cost
        description: Cost per unit in base currency (rate field)

      - name: trandate
        sql: "CAST({CUBE}.trandate AS TIMESTAMP)"
        type: time
        title: PO Date
        description: Purchase order transaction date (from header via denormalization)

    joins:
      - name: purchase_orders
        relationship: many_to_one
        sql: "{CUBE}.transaction = {purchase_orders}.id"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items}.id"

    pre_aggregations:
      - name: on_order_summary
        measures:
          - total_outstanding_qty
          - on_order_value
          - line_count
          - total_ordered_qty
          - total_received_qty
        dimensions:
          - item
          - purchase_orders.supplier
          - vendors.vendor_name
        time_dimension: trandate
        granularity: day
        refresh_key:
          every: 1 day
