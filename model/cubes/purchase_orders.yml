cubes:
  - name: purchase_orders
    sql_table: gpc.purchase_orders

    title: Purchase Orders
    description: Purchase order transaction headers from suppliers

    measures:
      - name: po_count
        type: count
        description: Number of purchase orders

      - name: total_po_value
        sql: total
        type: sum
        format: currency
        description: Total PO value in EUR (base currency)

      - name: avg_po_value
        sql: "{total_po_value} / NULLIF({po_count}, 0)"
        type: number
        format: currency
        description: Average PO value (calculated from components, NOT for use in pre-aggregations)

      - name: pending_receipt_count
        type: count
        filters:
          - sql: "{CUBE}.status = 'B'"
        description: POs pending receipt (status B)

      - name: partially_received_count
        type: count
        filters:
          - sql: "{CUBE}.status = 'D'"
        description: POs partially received (status D)

      - name: pending_billing_count
        type: count
        filters:
          - sql: "{CUBE}.status = 'E'"
        description: POs pending billing (status E)

      - name: open_po_count
        type: count
        filters:
          - sql: "{CUBE}.status IN ('B', 'D', 'E')"
        description: Open POs (pending receipt, partially received, or pending billing)

    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
        public: false

      - name: tranid
        sql: tranid
        type: string
        title: PO Number
        description: Purchase order transaction number

      - name: trandate
        sql: trandate
        type: time
        title: PO Date
        description: Purchase order transaction date

      - name: status
        sql: status
        type: string
        title: PO Status
        description: Purchase order status code (A=Pending Approval, B=Pending Receipt, D=Partially Received, E=Pending Billing, F=Fully Billed, G=Closed)

      - name: supplier
        sql: entity
        type: number
        title: Supplier ID
        description: Vendor entity ID

      - name: currency
        sql: currency
        type: string
        title: Currency
        description: Transaction currency code

      - name: exchangerate
        sql: exchangerate
        type: number
        title: Exchange Rate
        description: Currency exchange rate to base currency

      - name: foreigntotal
        sql: foreigntotal
        type: number
        format: currency
        title: Foreign Total
        description: Total in foreign currency

      - name: memo
        sql: memo
        type: string
        title: Memo
        description: PO memo field

    joins:
      - name: purchase_order_lines
        relationship: one_to_many
        sql: "{CUBE}.id = {purchase_order_lines}.po_id"

    pre_aggregations:
      - name: po_summary
        measures:
          - po_count
          - total_po_value
          # avg_po_value removed - calculate at query time from total_po_value / po_count
          - pending_receipt_count
          - partially_received_count
          - pending_billing_count
          - open_po_count
        dimensions:
          - status
          - supplier
        refresh_key:
          every: 1 day
