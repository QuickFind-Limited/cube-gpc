cubes:
  - name: dim_customer
    sql: SELECT * FROM gpc_data_2026_01_26.dim_customer
    title: Customers
    description: >
      Customer dimension including both real customers and system entities (webstore, POS).
      Grain: one row per customer.
      Use segments to filter out system entities for customer-facing analytics.

    measures:
      - name: customer_count
        type: count
        description: Total number of customer records

      - name: real_customer_count
        type: count
        sql: "{CUBE}.customer_id"
        filters:
          - sql: "{CUBE}.customer_in_scope = true"
        description: Count of real customers (excludes webstore/POS system entities)

    dimensions:
      - name: customer_id
        sql: "{CUBE}.customer_id"
        type: number
        primary_key: true
        description: Unique identifier for the customer

      - name: customer_code
        sql: "{CUBE}.customer_code"
        type: string
        description: Customer code or reference number

      - name: company_name
        sql: "{CUBE}.company_name"
        type: string
        description: Company name for business customers

      - name: first_name
        sql: "{CUBE}.first_name"
        type: string
        description: First name for individual customers

      - name: last_name
        sql: "{CUBE}.last_name"
        type: string
        description: Last name for individual customers

      - name: full_name
        sql: "COALESCE({CUBE}.company_name, CONCAT(COALESCE({CUBE}.first_name, ''), ' ', COALESCE({CUBE}.last_name, '')))"
        type: string
        description: Full name - company name for businesses, or first + last name for individuals

      - name: email
        sql: "{CUBE}.email"
        type: string
        description: Customer email address

      - name: phone
        sql: "{CUBE}.phone"
        type: string
        description: Customer phone number

      - name: entity_type
        sql: "{CUBE}.entity_type"
        type: string
        description: Type of entity - 'customer' for real customers, 'webstore' or 'pos' for system entities

      - name: is_test_entity
        sql: "{CUBE}.is_test_entity"
        type: boolean
        description: True if this is a test entity (not a real customer)

      - name: customer_in_scope
        sql: "{CUBE}.customer_in_scope"
        type: boolean
        description: True if this is an in-scope customer (excludes webstore, POS, and test entities)

      - name: subsidiary_id
        sql: "{CUBE}.subsidiary_id"
        type: number
        description: Foreign key to subsidiary dimension

      - name: category_id
        sql: "{CUBE}.category_id"
        type: number
        description: Foreign key to customer category

      - name: is_inactive
        sql: "{CUBE}.is_inactive"
        type: boolean
        description: True if the customer record is inactive

      - name: is_person
        sql: "{CUBE}.is_person"
        type: boolean
        description: True if this is an individual person, false if it's a business entity

      - name: date_created
        sql: "TIMESTAMP({CUBE}.date_created)"
        type: time
        description: Date when the customer record was created

      - name: last_modified_date
        sql: "TIMESTAMP({CUBE}.last_modified_date)"
        type: time
        description: Date when the customer record was last modified

    segments:
      - name: customers_only
        sql: "{CUBE}.customer_in_scope = true"
        description: "Real customers only - excludes webstore, POS, and test entities for accurate business metrics"

      - name: in_scope_only
        sql: "{CUBE}.customer_in_scope = true"
        description: "In-scope customers - excludes system entities (alias for customers_only)"

      - name: exclude_webstore
        sql: "{CUBE}.entity_type != 'webstore' OR {CUBE}.entity_type IS NULL"
        description: "Excludes webstore payment processor entities"

      - name: exclude_pos
        sql: "{CUBE}.entity_type != 'pos' OR {CUBE}.entity_type IS NULL"
        description: "Excludes POS system entities"

      - name: exclude_test
        sql: "{CUBE}.is_test_entity = false"
        description: "Excludes test entities"

      - name: active_customers
        sql: "{CUBE}.is_inactive = false"
        description: "Active customers only"

      - name: active_real_customers
        sql: "{CUBE}.is_inactive = false AND {CUBE}.customer_in_scope = true"
        description: "Active real customers (excludes inactive and system entities)"

      - name: individual_customers
        sql: "{CUBE}.is_person = true"
        description: "Individual person customers only"

      - name: business_customers
        sql: "{CUBE}.is_person = false"
        description: "Business entity customers only"

      - name: system_entities
        sql: "{CUBE}.customer_in_scope = false"
        description: "System entities only (webstore, POS, test) - for reconciliation and audit"
