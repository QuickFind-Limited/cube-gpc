cubes:
  - name: item_receipts
    sql_table: gpc.item_receipts

    title: Item Receipts
    description: Item receipt transaction headers (goods received from suppliers)

    measures:
      - name: receipt_count
        type: count
        description: Number of item receipts

      - name: total_receipt_value
        sql: "CAST(total AS FLOAT64)"
        type: sum
        format: currency
        description: Total receipt value in base currency

      - name: avg_receipt_value
        sql: "CAST(total AS FLOAT64)"
        type: avg
        format: currency
        description: Average receipt value

    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
        public: false

      - name: tranid
        sql: tranid
        type: string
        title: Receipt Number
        description: Item receipt transaction number

      - name: trandate
        sql: "CAST(PARSE_DATE('%d/%m/%Y', trandate) AS TIMESTAMP)"
        type: time
        title: Receipt Date
        description: Date of receipt

      - name: supplier
        sql: entity
        type: number
        title: Supplier ID
        description: Vendor entity ID

      - name: currency
        sql: currency
        type: number
        title: Currency
        description: Transaction currency ID

      - name: exchangerate
        sql: exchangerate
        type: number
        title: Exchange Rate
        description: Currency exchange rate to base currency

      - name: memo
        sql: memo
        type: string
        title: Memo
        description: Receipt memo field

    joins:
      - name: item_receipt_lines
        relationship: one_to_many
        sql: "{CUBE}.id = {item_receipt_lines}.receipt_id"

      - name: vendors
        relationship: many_to_one
        sql: "{CUBE}.entity = {vendors}.id"

    pre_aggregations:
      - name: receipt_summary
        measures:
          - receipt_count
          - total_receipt_value
          - avg_receipt_value
        dimensions:
          - supplier
          - currency
          - vendors.vendor_name
        time_dimension: trandate
        granularity: day
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day

      - name: receipt_monthly
        measures:
          - receipt_count
          - total_receipt_value
          - avg_receipt_value
        dimensions:
          - supplier
          - currency
        time_dimension: trandate
        granularity: month
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
