cubes:
  - name: cogs_accounting_lines
    sql: SELECT * FROM `gpc_data_2026_01_26.cogs_accounting_lines`
    title: COGS Accounting Lines
    description: >
      Cost of Goods Sold accounting line entries.
      Grain: one row per COGS accounting line entry.

    joins:
      - name: transactions
        relationship: many_to_one
        sql: "{{CUBE}}.transaction = {{transactions.id}}"

      - name: accounts
        relationship: many_to_one
        sql: "{{CUBE}}.account = {{accounts.account_id}}"

    measures:
      - name: cogs_accounting_lines_count
        type: count
        description: Total number of COGS accounting line entries

      - name: total_amount
        sql: "CAST({{CUBE}}.amount AS FLOAT64)"
        type: sum
        format: currency
        description: Total COGS amount across all lines

      - name: total_debit
        sql: "CAST({{CUBE}}.debit AS FLOAT64)"
        type: sum
        format: currency
        description: Total debit amount for COGS entries

      - name: total_credit
        sql: "CAST({{CUBE}}.credit AS FLOAT64)"
        type: sum
        format: currency
        description: Total credit amount for COGS entries

      - name: net_amount
        sql: "CAST({{CUBE}}.debit AS FLOAT64) - CAST({{CUBE}}.credit AS FLOAT64)"
        type: sum
        format: currency
        description: Net amount (debit - credit) for COGS entries

    dimensions:
      - name: transaction
        sql: "{{CUBE}}.transaction"
        type: number
        description: Foreign key to transaction header
        primary_key: true

      - name: transactionline
        sql: "{{CUBE}}.transactionline"
        type: number
        description: Transaction line sequence number
        primary_key: true

      - name: amount
        sql: "CAST({{CUBE}}.amount AS FLOAT64)"
        type: number
        description: COGS line amount

      - name: debit
        sql: "CAST({{CUBE}}.debit AS FLOAT64)"
        type: number
        description: Debit amount for this COGS line

      - name: credit
        sql: "CAST({{CUBE}}.credit AS FLOAT64)"
        type: number
        description: Credit amount for this COGS line

      - name: trandate
        sql: "TIMESTAMP({{CUBE}}.trandate)"
        type: time
        description: Transaction date

      - name: account
        sql: "{{CUBE}}.account"
        type: number
        description: GL account number for COGS posting

      - name: posting
        sql: "{{CUBE}}.posting"
        type: boolean
        description: Indicates if this is a posting transaction

    segments:
      - name: posting_only
        sql: "{{CUBE}}.posting = true"
        description: "Only lines that are posting to the GL"

      - name: non_posting
        sql: "{{CUBE}}.posting = false"
        description: "Non-posting lines (e.g., memo entries)"

      - name: debit_entries
        sql: "{{CUBE}}.debit > 0"
        description: "Lines with debit entries"

      - name: credit_entries
        sql: "{{CUBE}}.credit > 0"
        description: "Lines with credit entries"

    pre_aggregations:
      - name: daily_cogs
        measures:
          - cogs_accounting_lines_count
          - total_amount
          - total_debit
          - total_credit
        dimensions:
          - posting
        time_dimension: trandate
        granularity: day
        refresh_key:
          every: 1 day
