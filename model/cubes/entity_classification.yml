cubes:
  - name: entity_classification
    sql: SELECT * FROM gpc_data_2026_01_26.entity_classification
    title: Entity Classification
    description: >
      Entity classification lookup for identifying system entities (webstore, POS) vs real customers.
      Used for contamination filtering to exclude payment processor and system entities from customer analytics.
      Grain: one row per entity with classification flags.

    measures:
      - name: entity_count
        type: count
        description: Total number of entities

      - name: customer_entity_count
        type: count
        sql: "{CUBE}.entity_id"
        filters:
          - sql: "{CUBE}.entity_type = 'customer'"
        description: Count of real customer entities

      - name: webstore_entity_count
        type: count
        sql: "{CUBE}.entity_id"
        filters:
          - sql: "{CUBE}.entity_type = 'webstore'"
        description: Count of webstore system entities

      - name: pos_entity_count
        type: count
        sql: "{CUBE}.entity_id"
        filters:
          - sql: "{CUBE}.entity_type = 'pos'"
        description: Count of POS system entities

      - name: test_entity_count
        type: count
        sql: "{CUBE}.entity_id"
        filters:
          - sql: "{CUBE}.is_test_entity = true"
        description: Count of test entities

    dimensions:
      - name: entity_id
        sql: "{CUBE}.entity_id"
        type: number
        primary_key: true
        description: Unique identifier for the entity (customer, vendor, etc.)

      - name: entity_type
        sql: "{CUBE}.entity_type"
        type: string
        description: "Classification of entity: 'customer' (real customer), 'webstore' (payment processor), 'pos' (point-of-sale system)"

      - name: is_test_entity
        sql: "{CUBE}.is_test_entity"
        type: boolean
        description: True if this is a test entity that should be excluded from production analytics

    segments:
      - name: customer_entities
        sql: "{CUBE}.entity_type = 'customer'"
        description: "Real customer entities only - excludes webstore and POS system entities"

      - name: system_entities
        sql: "{CUBE}.entity_type IN ('webstore', 'pos')"
        description: "System entities only (webstore payment processors and POS systems)"

      - name: webstore_entities
        sql: "{CUBE}.entity_type = 'webstore'"
        description: "Webstore payment processor entities (Stripe, PayPal, etc.)"

      - name: pos_entities
        sql: "{CUBE}.entity_type = 'pos'"
        description: "Point-of-sale system entities"

      - name: production_entities
        sql: "{CUBE}.is_test_entity = false"
        description: "Excludes test entities for production reporting"

      - name: test_entities
        sql: "{CUBE}.is_test_entity = true"
        description: "Test entities only"

      - name: real_customers_production
        sql: "{CUBE}.entity_type = 'customer' AND {CUBE}.is_test_entity = false"
        description: "Real customer entities excluding test data - primary segment for customer analytics"
