cubes:
  - name: customer_deposits
    sql: >
      SELECT
        tl.transaction,
        tl.amount,
        tl.netamount,
        tl.quantity,
        tl.trandate as deposit_date,
        SAFE_CAST(t.entity AS INT64) as customer_id,
        t.paymentmethod,
        t.currency,
        t.exchangerate,
        t.foreigntotal,
        t.total,
        t.subsidiary,
        t.tranid as deposit_number,
        t.status,
        t.memo
      FROM gpc.transaction_lines tl
      LEFT JOIN gpc.transaction t
        ON tl.transaction = SAFE_CAST(t.id AS INT64)
      WHERE tl.transaction_type = 'CustDep'
        AND COALESCE(tl.mainline, 'F') = 'F'
        AND COALESCE(tl.taxline, 'F') = 'F'
        AND COALESCE(t.posting, 'T') = 'T'
        AND COALESCE(t.voided, 'F') = 'F'
    title: Customer Deposits
    description: >
      Customer deposit transactions (CustDep) representing cash collected
      before fulfillment. Amounts are stored as negatives in NetSuite and
      are ABS() converted in measures.

    joins:
      - name: b2b_customers
        relationship: many_to_one
        sql: "{CUBE}.customer_id = {b2b_customers.id}"

    measures:
      - name: deposit_inflow
        sql: "ABS({CUBE}.amount)"
        type: sum
        format: currency
        description: "Total customer deposit inflow (ABS of line amount)."

      - name: deposit_count
        type: count
        description: "Number of customer deposits."

      - name: deposit_transaction_count
        sql: "{CUBE}.transaction"
        type: count_distinct_approx
        description: "Number of unique customer deposits (approximate)."

      - name: average_deposit_size
        sql: "{deposit_inflow} / NULLIF({deposit_transaction_count}, 0)"
        type: number
        format: currency
        public: false
        description: "Average deposit size (calculated from components)."

    dimensions:
      - name: id
        sql: "{CUBE}.transaction"
        type: number
        primary_key: true

      - name: customer_id
        sql: "{CUBE}.customer_id"
        type: number
        description: "Customer entity ID"

      - name: customer_type
        type: string
        case:
          when:
            - sql: "{b2b_customers.id} IS NOT NULL"
              label: "B2B/Wholesale"
          else:
            label: "Retail/D2C"
        description: "Customer type derived from B2B customer lookup"

      - name: paymentmethod
        sql: "{CUBE}.paymentmethod"
        type: string
        description: "Payment method ID from NetSuite header"

      - name: deposit_date
        sql: "CAST({CUBE}.deposit_date AS TIMESTAMP)"
        type: time
        description: "Deposit transaction date"

      - name: subsidiary
        sql: "SAFE_CAST({CUBE}.subsidiary AS INT64)"
        type: number
        description: "Subsidiary ID"

      - name: currency
        sql: "SAFE_CAST({CUBE}.currency AS INT64)"
        type: number
        description: "Currency ID"

      - name: deposit_number
        sql: "{CUBE}.deposit_number"
        type: string
        description: "Deposit transaction number"

      - name: status
        sql: "{CUBE}.status"
        type: string
        description: "Deposit status code"

    pre_aggregations:
      - name: deposit_summary
        measures:
          - deposit_inflow
          - deposit_count
          - deposit_transaction_count
        dimensions:
          - paymentmethod
          - customer_type
          - subsidiary
          - currency
        time_dimension: deposit_date
        granularity: day
        partition_granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
