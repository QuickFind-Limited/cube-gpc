cubes:
  - name: cross_sell
    sql: >
      SELECT
        item_a,
        item_b,
        item_a_sku,
        item_b_sku,
        item_a_name,
        item_b_name,
        item_a_category,
        item_b_category,
        item_a_section,
        item_b_section,
        transaction_type,
        trandate,
        co_purchase_count
      FROM gpc.cross_sell_deduplicated
    title: Cross-Sell Analysis
    description: >
      Product affinity pairs by transaction date showing items purchased together (BASK002).
      Uses cross_sell_deduplicated BigQuery view for canonical pair representation.
      Data is partitioned by month. To get total historical co-purchases, sum total_co_purchases
      across all time periods without date filter. For recent trends, filter by date range.

      IMPORTANT: Bidirectional pairs are canonicalized using LEAST/GREATEST in the view.
      Each category/section pair appears only once with COMBINED counts from both directions.
      Example: Men+Women (732,586) combines previous Men→Women (402,907) + Women→Men (329,679).
      Ordering: Alphabetical by category, then by section within same category.
      This eliminates duplicate pairs while preserving all co-purchase data (no data loss).

    measures:
      - name: pair_count
        type: count
        description: Number of product pairs

      - name: total_co_purchases
        sql: "CAST({CUBE}.co_purchase_count AS FLOAT64)"
        type: sum
        description: Total co-purchase occurrences

      - name: average_co_purchases
        sql: "{total_co_purchases} / NULLIF({pair_count}, 0)"
        type: number
        description: "Average co-purchase count per pair (calculated from components, NOT for use in pre-aggregations)"

      - name: max_co_purchases
        sql: "{CUBE}.co_purchase_count"
        type: max
        description: Maximum co-purchase count

    dimensions:
      - name: id
        sql: "CONCAT(CAST({CUBE}.item_a AS STRING), '-', CAST({CUBE}.item_b AS STRING))"
        type: string
        primary_key: true

      - name: item_a
        sql: "{CUBE}.item_a"
        type: number
        description: First item ID

      - name: item_b
        sql: "{CUBE}.item_b"
        type: number
        description: Second item ID

      - name: item_a_sku
        sql: "{CUBE}.item_a_sku"
        type: string
        description: First item SKU

      - name: item_b_sku
        sql: "{CUBE}.item_b_sku"
        type: string
        description: Second item SKU

      - name: item_a_name
        sql: "{CUBE}.item_a_name"
        type: string
        description: First item name

      - name: item_b_name
        sql: "{CUBE}.item_b_name"
        type: string
        description: Second item name

      - name: item_a_category
        sql: "{CUBE}.item_a_category"
        type: string
        description: First item category

      - name: item_b_category
        sql: "{CUBE}.item_b_category"
        type: string
        description: Second item category

      - name: item_a_section
        sql: "{CUBE}.item_a_section"
        type: string
        description: First item section

      - name: item_b_section
        sql: "{CUBE}.item_b_section"
        type: string
        description: Second item section

      - name: transaction_type
        sql: "{CUBE}.transaction_type"
        type: string
        description: "Transaction type: SalesOrd, CustInvc, CashSale. Previously hardcoded to CustInvc/CashSale only. Now parameterized for flexible filtering."

      - name: co_purchase_count
        sql: "{CUBE}.co_purchase_count"
        type: number
        description: Number of times purchased together

      # Parameterized Time Dimension - Default: "Last 12 months"
      - name: trandate
        sql: "{CUBE}.trandate"
        type: time
        description: "Transaction date - PARAMETERIZED: Use timeDimensions with dateRange (default: 'last 12 months')"

    segments:
      - name: high_affinity
        sql: "{CUBE}.co_purchase_count >= 10"

      - name: same_category
        sql: "{CUBE}.item_a_category = {CUBE}.item_b_category"

      - name: cross_category
        sql: "{CUBE}.item_a_category != {CUBE}.item_b_category"

    # Pre-aggregation enabled for BASK002
    # Fixed: Now uses transaction_lines_denormalized_mv (materialized view) for faster builds
    pre_aggregations:
      - name: cross_sell_analysis
        measures:
          - pair_count
          - total_co_purchases
          - max_co_purchases
        dimensions:
          - item_a_category
          - item_b_category
          - item_a_section
          - item_b_section
          - transaction_type  # Added for filter compatibility (SKILL defaults)
        time_dimension: trandate
        granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
