cubes:
  - name: cross_sell
    sql: >
      SELECT
        tl1.item as item_a,
        tl2.item as item_b,
        tl1.sku as item_a_sku,
        tl2.sku as item_b_sku,
        tl1.product_name as item_a_name,
        tl2.product_name as item_b_name,
        tl1.category as item_a_category,
        tl2.category as item_b_category,
        tl1.section as item_a_section,
        tl2.section as item_b_section,
        tl1.transaction_type,
        CAST(tl1.transaction_date AS TIMESTAMP) as trandate,
        CAST(COUNT(DISTINCT tl1.transaction) AS INT64) as co_purchase_count
      FROM gpc.transaction_lines_denormalized_mv tl1
      JOIN gpc.transaction_lines_denormalized_mv tl2
        ON tl1.transaction = tl2.transaction AND tl1.item < tl2.item
      WHERE tl1.quantity < 0
        AND tl2.quantity < 0
      GROUP BY tl1.item, tl2.item, tl1.sku, tl2.sku, tl1.product_name, tl2.product_name,
               tl1.category, tl2.category,
               tl1.section, tl2.section,
               tl1.transaction_type, CAST(tl1.transaction_date AS TIMESTAMP)
    title: Cross-Sell Analysis
    description: >
      Product affinity pairs by transaction date showing items purchased together (BASK002).
      Uses transaction_lines_denormalized_mv for optimized performance (fixed join issue).
      Data is partitioned by month. To get total historical co-purchases, sum total_co_purchases
      across all time periods without date filter. For recent trends, filter by date range.

    measures:
      - name: pair_count
        type: count
        description: Number of product pairs

      - name: total_co_purchases
        sql: "CAST({CUBE}.co_purchase_count AS FLOAT64)"
        type: sum
        description: Total co-purchase occurrences

      - name: average_co_purchases
        sql: "{total_co_purchases} / NULLIF({pair_count}, 0)"
        type: number
        description: "Average co-purchase count per pair (calculated from components, NOT for use in pre-aggregations)"

      - name: max_co_purchases
        sql: "{CUBE}.co_purchase_count"
        type: max
        description: Maximum co-purchase count

    dimensions:
      - name: id
        sql: "CONCAT(CAST({CUBE}.item_a AS STRING), '-', CAST({CUBE}.item_b AS STRING))"
        type: string
        primary_key: true

      - name: item_a
        sql: "{CUBE}.item_a"
        type: number
        description: First item ID

      - name: item_b
        sql: "{CUBE}.item_b"
        type: number
        description: Second item ID

      - name: item_a_sku
        sql: "{CUBE}.item_a_sku"
        type: string
        description: First item SKU

      - name: item_b_sku
        sql: "{CUBE}.item_b_sku"
        type: string
        description: Second item SKU

      - name: item_a_name
        sql: "{CUBE}.item_a_name"
        type: string
        description: First item name

      - name: item_b_name
        sql: "{CUBE}.item_b_name"
        type: string
        description: Second item name

      - name: item_a_category
        sql: "{CUBE}.item_a_category"
        type: string
        description: First item category

      - name: item_b_category
        sql: "{CUBE}.item_b_category"
        type: string
        description: Second item category

      - name: item_a_section
        sql: "{CUBE}.item_a_section"
        type: string
        description: First item section

      - name: item_b_section
        sql: "{CUBE}.item_b_section"
        type: string
        description: Second item section

      - name: transaction_type
        sql: "{CUBE}.transaction_type"
        type: string
        description: "Transaction type: SalesOrd, CustInvc, CashSale. Previously hardcoded to CustInvc/CashSale only. Now parameterized for flexible filtering."

      - name: co_purchase_count
        sql: "{CUBE}.co_purchase_count"
        type: number
        description: Number of times purchased together

      # Parameterized Time Dimension - Default: "Last 12 months"
      - name: trandate
        sql: "{CUBE}.trandate"
        type: time
        description: "Transaction date - PARAMETERIZED: Use timeDimensions with dateRange (default: 'last 12 months')"

    segments:
      - name: high_affinity
        sql: "{CUBE}.co_purchase_count >= 10"

      - name: same_category
        sql: "{CUBE}.item_a_category = {CUBE}.item_b_category"

      - name: cross_category
        sql: "{CUBE}.item_a_category != {CUBE}.item_b_category"

    # Pre-aggregation enabled for BASK002
    # Fixed: Now uses transaction_lines_denormalized_mv (materialized view) for faster builds
    pre_aggregations:
      - name: cross_sell_analysis
        measures:
          - pair_count
          - total_co_purchases
          - max_co_purchases
        dimensions:
          - item_a_category
          - item_b_category
          - item_a_section
          - item_b_section
          - transaction_type  # Added for filter compatibility (SKILL defaults)
        time_dimension: trandate
        granularity: month
        build_range_end:
          sql: SELECT '2025-10-31'
        refresh_key:
          every: 1 day
