cubes:
  - name: fulfillment_lines
    sql: >
      SELECT
        fl.*,
        PARSE_DATE('%Y-%m-%d', fl.shipdate) as shipdate_parsed,
        t.trandate as order_date
      FROM gpc.fulfillment_lines fl
      LEFT JOIN gpc.transactions_analysis t
        ON CAST(fl.createdfrom AS INT64) = t.id
    title: Fulfillment Lines
    description: >
      Individual line items for fulfillments tracking what products were shipped.
      FD002 FIX (v68.2): Denormalized order_date from transactions into cube SQL to enable
      pre-aggregation of fulfillment days metrics without cross-cube JOIN issues.

    joins:
      - name: fulfillments
        relationship: many_to_one
        sql: "{CUBE}.transaction = {fulfillments.id}"

      - name: transactions
        relationship: many_to_one
        sql: "CAST({CUBE}.createdfrom AS STRING) = {transactions.id}"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.id}"

      - name: locations
        relationship: many_to_one
        sql: "{CUBE}.location = {locations.id}"

    measures:
      - name: line_count
        type: count
        description: Total number of fulfillment lines

      - name: units_shipped
        sql: "CAST({CUBE}.quantity AS FLOAT64)"
        type: sum
        description: Total units shipped

      - name: fulfillment_count
        sql: "{CUBE}.transaction"
        type: count_distinct_approx
        description: "Number of unique fulfillments (FM003). NetSuite investigation shows ~10-13% of fulfillment lines have NULL location across all time periods (2024-2025), not 45% as initially reported. NULL locations appear consistently across all months with no specific pattern, suggesting this is expected behavior for certain fulfillment types (e.g., drop-ship, transfers, or pre-2024 data). FIX (v65): Verified actual NULL rate via NetSuite SuiteQL API - corrected from inflated 45% estimate to measured 10-13% reality."

      - name: sku_count
        sql: "{CUBE}.item"
        type: count_distinct_approx
        description: Number of unique SKUs shipped (approximate with HyperLogLog)

      - name: location_count
        sql: "{CUBE}.location"
        type: count_distinct_approx
        description: Number of shipping locations (approximate with HyperLogLog)

      - name: total_fulfillment_days
        sql: "CAST(DATE_DIFF({CUBE}.shipdate_parsed, CAST({CUBE}.order_date AS DATE), DAY) AS FLOAT64)"
        type: sum
        description: >
          Total days from order to ship (for averaging - FD002).
          FD002 FIX (FD002-fix-1): Changed join from fulfillments.entity to createdfrom field.
          Old path (98.3% NULL): fulfillment_lines → fulfillments.entity → transactions (1,146 days avg - wrong!)
          New path (83.7% coverage): fulfillment_lines.createdfrom → transactions (20.5 days avg, 2 days median - correct!)
          FD002 FIX (FD002-fix-3): Denormalized order_date into cube SQL to avoid cross-cube JOIN in pre-aggregation.

      - name: lines_with_order_date
        sql: "CASE WHEN {CUBE}.order_date IS NOT NULL THEN 1 END"
        type: count
        description: >
          Count of fulfillment lines with valid order date (FD002).
          Used as denominator for average_fulfillment_days calculation.
          Sept 2025: 78,230 of 93,436 lines (83.7%) have valid order dates.
          FD002 FIX (FD002-fix-3): Uses denormalized order_date field instead of cross-cube JOIN.

      - name: average_fulfillment_days
        sql: "1.0 * {total_fulfillment_days} / NULLIF({lines_with_order_date}, 0)"
        type: number
        description: >
          Average days from order to ship (FD002).
          FD002 FIX (FD002-fix-2): Changed denominator to lines_with_order_date (not line_count or fulfillment_count).
          Old method #1: total_days / fulfillment_count (98.6 days - multi-line fulfillments inflated).
          Old method #2: total_days / line_count (17.2 days - includes NULL dates).
          New method: total_days / lines_with_order_date (20.5 days - CORRECT).
          Sept 2025: 20.5 days average, 2 days median (Wholesale UK 115-day outlier pulls average up).
          Use with location_label dimension to see DC vs Store breakdowns.

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: transaction
        sql: "{CUBE}.transaction"
        type: number
        description: Parent fulfillment ID

      - name: createdfrom
        sql: "{CUBE}.createdfrom"
        type: number
        description: Source order ID

      - name: item
        sql: "{CUBE}.item"
        type: number
        description: Item ID

      - name: location
        sql: "{CUBE}.location"
        type: number
        description: Shipping location ID

      - name: quantity
        sql: "{CUBE}.quantity"
        type: number
        description: Quantity shipped

      - name: quantityshiprecv
        sql: "{CUBE}.quantityshiprecv"
        type: number
        description: Quantity shipped/received

      - name: shipdate
        sql: "CAST({CUBE}.shipdate_parsed AS TIMESTAMP)"
        type: time
        description: Ship date

      - name: month
        sql: "TIMESTAMP_TRUNC(CAST({CUBE}.shipdate_parsed AS TIMESTAMP), MONTH)"
        type: time
        description: Ship month

      - name: location_label
        sql: >
          CASE
            WHEN {locations.name} LIKE '%Bleckmann%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%Meteor%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%PCH%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%2Flow%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%Wholesale%' THEN CONCAT('B2B-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {CUBE}.location BETWEEN 1 AND 12 THEN CONCAT('Store-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} IS NULL THEN 'NULL'
            ELSE CONCAT('LOC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
          END
        type: string
        description: "Labeled location name with type prefix and ID for FD002. DC (Distribution Center), Store (Retail), B2B (Wholesale/Partners), LOC (Other)."

      - name: order_date
        sql: "CAST({CUBE}.order_date AS TIMESTAMP)"
        type: time
        description: "Order date from source transaction (denormalized from transactions table via createdfrom)"

    segments:
      - name: shipped_lines
        sql: "{CUBE}.quantity > 0"

    pre_aggregations:
      # Fulfillment line analysis
      - name: fulfillment_lines_analysis
        measures:
          - line_count
          - units_shipped
          - fulfillment_count
          - sku_count
          - location_count
          - total_fulfillment_days
          - lines_with_order_date  # FD002 fix (FD002-fix-2): Denominator for average calculation
          # average_fulfillment_days excluded - calculated measure (total_days / lines_with_order_date)
        dimensions:
          - location
          - locations.name
          - location_label  # FD002 fix (FD002-fix-1): Added for labeled location queries
        time_dimension: shipdate
        granularity: day
        build_range_end:
          sql: SELECT '2025-10-31'
        indexes:
          - name: location_idx
            columns:
              - location
        refresh_key:
          every: 1 day

      # Item-level fulfillment tracking
      - name: item_fulfillment_analysis
        measures:
          - units_shipped
          - fulfillment_count
        dimensions:
          - item
          - location
        time_dimension: shipdate
        granularity: day
        build_range_end:
          sql: SELECT '2025-10-31'
        indexes:
          - name: item_idx
            columns:
              - item
        refresh_key:
          every: 1 day

      # Snapshot pre-agg for location-based queries without time filtering
      - name: location_snapshot
        measures:
          - fulfillment_count
          - line_count
          - units_shipped
        dimensions:
          - location
          - locations.name
        refresh_key:
          every: 1 day
