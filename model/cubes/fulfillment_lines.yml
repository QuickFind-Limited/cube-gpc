cubes:
  - name: fulfillment_lines
    sql: SELECT * FROM gpc.fulfillment_lines
    title: Fulfillment Lines
    description: Individual line items for fulfillments tracking what products were shipped

    joins:
      - name: fulfillments
        relationship: many_to_one
        sql: "{CUBE}.transaction = {fulfillments.id}"

      - name: transactions
        relationship: many_to_one
        sql: "{CUBE}.createdfrom = {transactions.id}"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.id}"

      - name: locations
        relationship: many_to_one
        sql: "{CUBE}.location = {locations.id}"

    measures:
      - name: line_count
        type: count
        description: Total number of fulfillment lines

      - name: units_shipped
        sql: "CAST({CUBE}.quantity AS FLOAT64)"
        type: sum
        description: Total units shipped

      - name: fulfillment_count
        sql: "{CUBE}.transaction"
        type: count_distinct_approx
        description: "Number of unique fulfillments (FM003). NetSuite investigation shows ~10-13% of fulfillment lines have NULL location across all time periods (2024-2025), not 45% as initially reported. NULL locations appear consistently across all months with no specific pattern, suggesting this is expected behavior for certain fulfillment types (e.g., drop-ship, transfers, or pre-2024 data). FIX (v65): Verified actual NULL rate via NetSuite SuiteQL API - corrected from inflated 45% estimate to measured 10-13% reality."

      - name: sku_count
        sql: "{CUBE}.item"
        type: count_distinct_approx
        description: Number of unique SKUs shipped (approximate with HyperLogLog)

      - name: location_count
        sql: "{CUBE}.location"
        type: count_distinct_approx
        description: Number of shipping locations (approximate with HyperLogLog)

      - name: total_fulfillment_days
        sql: "CAST(DATE_DIFF(CAST({CUBE}.shipdate AS DATE), CAST({transactions.trandate} AS DATE), DAY) AS FLOAT64)"
        type: sum
        description: >
          Total days from order to ship (for averaging - FD002).
          FD002 FIX (v72): Changed join from fulfillments.entity to createdfrom field.
          Old path (98.3% NULL): fulfillment_lines → fulfillments.entity → transactions (1,146 days avg - wrong!)
          New path (83.7% coverage): fulfillment_lines.createdfrom → transactions (20.5 days avg, 2 days median - correct!)

      - name: average_fulfillment_days
        sql: "1.0 * {total_fulfillment_days} / NULLIF({fulfillment_count}, 0)"
        type: number
        description: >
          Average days from order to ship (FD002).
          Sept 2025: 20.5 days average, 2 days median (Wholesale UK 115-day outlier pulls average up).
          Use with location_label dimension to see DC vs Store breakdowns.

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: transaction
        sql: "{CUBE}.transaction"
        type: number
        description: Parent fulfillment ID

      - name: createdfrom
        sql: "{CUBE}.createdfrom"
        type: number
        description: Source order ID

      - name: item
        sql: "{CUBE}.item"
        type: number
        description: Item ID

      - name: location
        sql: "{CUBE}.location"
        type: number
        description: Shipping location ID

      - name: quantity
        sql: "{CUBE}.quantity"
        type: number
        description: Quantity shipped

      - name: quantityshiprecv
        sql: "{CUBE}.quantityshiprecv"
        type: number
        description: Quantity shipped/received

      - name: shipdate
        sql: "CAST({CUBE}.shipdate AS TIMESTAMP)"
        type: time
        description: Ship date

      - name: month
        sql: "TIMESTAMP_TRUNC(CAST({CUBE}.shipdate AS TIMESTAMP), MONTH)"
        type: time
        description: Ship month

      - name: location_label
        sql: >
          CASE
            WHEN {locations.name} LIKE '%Bleckmann%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%Meteor%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%PCH%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%2Flow%' THEN CONCAT('DC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} LIKE '%Wholesale%' THEN CONCAT('B2B-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {CUBE}.location BETWEEN 1 AND 12 THEN CONCAT('Store-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
            WHEN {locations.name} IS NULL THEN 'NULL'
            ELSE CONCAT('LOC-', CAST({CUBE}.location AS STRING), ': ', {locations.name})
          END
        type: string
        description: "Labeled location name with type prefix and ID for FD002. DC (Distribution Center), Store (Retail), B2B (Wholesale/Partners), LOC (Other)."

    segments:
      - name: shipped_lines
        sql: "{CUBE}.quantity > 0"

    pre_aggregations:
      # Fulfillment line analysis
      - name: fulfillment_lines_analysis
        measures:
          - line_count
          - units_shipped
          - fulfillment_count
          - sku_count
          - location_count
          - total_fulfillment_days
          # Removed: average_fulfillment_days (calculated - references count_distinct_approx)
        dimensions:
          - location
          - locations.name
        time_dimension: shipdate
        granularity: day
        build_range_end:
          sql: SELECT '2025-10-31'
        indexes:
          - name: location_idx
            columns:
              - location
        refresh_key:
          every: 1 day

      # Item-level fulfillment tracking
      - name: item_fulfillment_analysis
        measures:
          - units_shipped
          - fulfillment_count
        dimensions:
          - item
          - location
        time_dimension: shipdate
        granularity: day
        build_range_end:
          sql: SELECT '2025-10-31'
        indexes:
          - name: item_idx
            columns:
              - item
        refresh_key:
          every: 1 day

      # Snapshot pre-agg for location-based queries without time filtering
      - name: location_snapshot
        measures:
          - fulfillment_count
          - line_count
          - units_shipped
        dimensions:
          - location
          - locations.name
        refresh_key:
          every: 1 day
