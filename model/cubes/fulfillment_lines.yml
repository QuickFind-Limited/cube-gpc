cubes:
  - name: fulfillment_lines
    sql: SELECT * FROM fulfillment_lines
    title: Fulfillment Lines
    description: Individual line items for fulfillments tracking what products were shipped

    joins:
      - name: fulfillments
        relationship: many_to_one
        sql: "{CUBE}.transaction = {fulfillments.id}"

      - name: items
        relationship: many_to_one
        sql: "{CUBE}.item = {items.id}"

      - name: locations
        relationship: many_to_one
        sql: "{CUBE}.location = {locations.id}"

    measures:
      - name: line_count
        type: count
        description: Total number of fulfillment lines

      - name: units_shipped
        sql: "CAST({CUBE}.quantity AS DOUBLE)"
        type: sum
        description: Total units shipped

      - name: fulfillment_count
        sql: "{CUBE}.transaction"
        type: count_distinct
        description: Number of unique fulfillments

      - name: sku_count
        sql: "{CUBE}.item"
        type: count_distinct
        description: Number of unique SKUs shipped

      - name: location_count
        sql: "{CUBE}.location"
        type: count_distinct
        description: Number of shipping locations

      - name: total_fulfillment_days
        sql: "DATE_DIFF('day', CAST({fulfillments.trandate} AS TIMESTAMP), CAST({CUBE}.shipdate AS TIMESTAMP))"
        type: sum
        description: Total days from order to ship (for averaging)

      - name: average_fulfillment_days
        sql: "1.0 * {total_fulfillment_days} / NULLIF({fulfillment_count}, 0)"
        type: number
        description: Average days from order to ship (FD002)

    dimensions:
      - name: id
        sql: "{CUBE}.id"
        type: number
        primary_key: true

      - name: transaction
        sql: "{CUBE}.transaction"
        type: number
        description: Parent fulfillment ID

      - name: createdfrom
        sql: "{CUBE}.createdfrom"
        type: number
        description: Source order ID

      - name: item
        sql: "{CUBE}.item"
        type: number
        description: Item ID

      - name: location
        sql: "{CUBE}.location"
        type: number
        description: Shipping location ID

      - name: quantity
        sql: "{CUBE}.quantity"
        type: number
        description: Quantity shipped

      - name: quantityshiprecv
        sql: "{CUBE}.quantityshiprecv"
        type: number
        description: Quantity shipped/received

      - name: shipdate
        sql: "CAST({CUBE}.shipdate AS TIMESTAMP)"
        type: time
        description: Ship date

      - name: month
        sql: "DATE_TRUNC('month', CAST({CUBE}.shipdate AS TIMESTAMP))"
        type: time
        description: Ship month

    segments:
      - name: shipped_lines
        sql: "{CUBE}.quantity > 0"

    pre_aggregations:
      # Fulfillment line analysis
      - name: fulfillment_lines_analysis
        measures:
          - line_count
          - units_shipped
          - fulfillment_count
          - sku_count
          - location_count
          - total_fulfillment_days
        dimensions:
          - location
        time_dimension: shipdate
        granularity: month
        partition_granularity: month
        refresh_key:
          every: 1 hour

      # Item-level fulfillment tracking
      - name: item_fulfillment_analysis
        measures:
          - units_shipped
          - fulfillment_count
        dimensions:
          - item
          - location
        time_dimension: shipdate
        granularity: month
        partition_granularity: month
        refresh_key:
          every: 1 hour
